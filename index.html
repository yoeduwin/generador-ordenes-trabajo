<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema Ejecutiva Ambiental - Perfil de Datos & Orden de Trabajo</title>

  <style>
    *{box-sizing:border-box}

    body{
      font-family: Arial, sans-serif;
      margin:0; padding:20px;
      background:#f5f5f5; font-size:12px;
    }
    .main-container{max-width:1200px;margin:0 auto;}

    /* Tabs */
    .nav-tabs{display:flex;background:#fff;border-radius:8px 8px 0 0;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .nav-tab{flex:1;padding:15px 20px;background:#e9ecef;border:0;cursor:pointer;font-weight:bold;font-size:14px;transition:.3s;display:flex;align-items:center;justify-content:center;gap:8px}
    .nav-tab.active{background:#1e5a3e;color:#fff}
    .nav-tab:hover:not(.active){background:#dee2e6}
    .tab-content{display:none;background:#fff;border-radius:0 0 8px 8px;box-shadow:0 2px 10px rgba(0,0,0,.1);min-height:600px}
    .tab-content.active{display:block}

    /* Barras de acciones */
    .excel-controls{background:linear-gradient(135deg,#f8f9fa,#e9ecef);padding:15px;margin-bottom:0;border-left:4px solid #1e5a3e;display:flex;align-items:center;flex-wrap:wrap;gap:10px}
    .excel-controls button{background:#1e5a3e;color:#fff;border:0;padding:8px 15px;border-radius:4px;cursor:pointer;font-size:11px}
    .excel-controls button:hover{background:#2d7a4f}
    .file-input-label{background:#6c757d;color:#fff;padding:8px 15px;border-radius:4px;cursor:pointer;font-size:11px;display:inline-block}
    .file-input-label:hover{background:#5a6268}
    .file-input-label input{display:none}
    .status-message{margin-left:10px;padding:5px 10px;border-radius:4px;font-size:10px;font-weight:bold}
    .status-success{background:#d4edda;color:#155724}
    .status-error{background:#f8d7da;color:#721c24}
    .status-warning{background:#fff3cd;color:#856404}

    /* Encabezados */
    .header{background:linear-gradient(135deg,#1e5a3e,#2d7a4f);color:#fff;padding:15px;display:flex;justify-content:space-between;align-items:center}
    .logo-section{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#1e5a3e;font-weight:bold}
    .company-info h1{margin:0;font-size:16px;font-weight:bold}
    .company-info p{margin:2px 0;font-size:10px;opacity:.9}
    .document-info h2{margin:0;font-size:18px;font-weight:bold}

    .section{border-bottom:1px solid #ddd}
    .section-header{background:#1e5a3e;color:#fff;padding:8px 15px;font-weight:bold;font-size:11px;text-transform:uppercase;letter-spacing:.5px}
    .section-content{padding:15px}

    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px}
    .form-group{display:flex;flex-direction:column}
    .form-group.full-width{grid-column:1 / -1}
    label{font-weight:bold;color:#333;margin-bottom:3px;font-size:10px;text-transform:uppercase}
    input[type="text"],input[type="date"],input[type="tel"],input[type="email"],textarea,select{border:1px solid #ccc;padding:6px 8px;font-size:11px;border-radius:3px;background:#f9f9f9}
    input:focus,textarea:focus,select:focus{outline:0;border-color:#1e5a3e;background:#fff}
    textarea{resize:vertical;min-height:60px}

    /* Tabla OT */
    .work-table{width:100%;border-collapse:collapse;margin-top:10px;table-layout:fixed;background:#fff}
    .work-table th{background:#1e5a3e;color:#fff;font-weight:bold;text-align:center;padding:8px 4px;font-size:11px;border:1px solid #1e5a3e;white-space:normal;word-wrap:break-word}
    .work-table td{border:1px solid #ddd;padding:4px;text-align:left;font-size:10px;vertical-align:middle;background:#fff}
    .work-table input[type="text"],.work-table input[type="date"],.work-table select,.work-table textarea{border:1px solid transparent;width:100%;height:28px;padding:2px 4px;background:#f9f9f9;font-size:10px;margin:0;box-sizing:border-box}
    .work-table textarea{min-height:28px;resize:vertical;font-family:Arial, sans-serif}
    .work-table input:focus,.work-table textarea:focus,.work-table select:focus{background:#fff;border:1px solid #1e5a3e;outline:none}
    .add-row-btn{background:#28a745;color:#fff;border:0;padding:8px 15px;border-radius:3px;cursor:pointer;font-size:11px;margin-top:10px}
    .add-row-btn:hover{background:#218838}
    .remove-row-btn{background:#dc3545;color:#fff;border:0;padding:4px 8px;border-radius:3px;cursor:pointer;font-size:10px}
    .remove-row-btn:hover{background:#c82333}

    /* Indicador de sync */
    .data-sync-indicator{position:fixed;top:20px;right:20px;background:#1e5a3e;color:#fff;padding:8px 15px;border-radius:20px;font-size:11px;z-index:1000;opacity:0;transition:opacity .3s}
    .data-sync-indicator.show{opacity:1}

    .excel-mapping-info{background:#e3f2fd;border:1px solid #1976d2;border-radius:4px;padding:10px;margin:10px 0;font-size:10px}
    .excel-mapping-info strong{color:#1976d2}

    /* Estilos para generadores de texto */
    .template-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:15px 0}
    .template-card{border:1px solid #e3e3e3;border-radius:8px;padding:15px;cursor:pointer;background:#fff;transition:.3s;position:relative}
    .template-card:hover{border-color:#1e5a3e;box-shadow:0 2px 8px rgba(30,90,62,.1)}
    .template-card.selected{border-color:#1e5a3e;box-shadow:0 0 0 2px #1e5a3e22}
    .template-card h4{margin:0 0 8px;color:#1e5a3e;font-size:14px}
    .template-card p{margin:0;color:#666;font-size:11px}
    .text-output{background:#f8f9fa;border:1px solid #ddd;border-radius:4px;padding:15px;min-height:200px;white-space:pre-wrap;font-family:monospace;font-size:11px;margin:10px 0}
    .copy-btn{background:#28a745;color:#fff;border:0;padding:8px 15px;border-radius:4px;cursor:pointer;font-size:11px;margin-top:10px}
    .copy-btn:hover{background:#218838}

    /* Documentos PDF */
    .document-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin:15px 0}
    .document-card{border:1px solid #e3e3e3;border-radius:8px;padding:15px;background:#fff}
    .document-card h4{margin:0 0 10px;color:#1e5a3e;font-size:14px}
    .document-card p{margin:0 0 10px;color:#666;font-size:11px}
    .document-actions{display:flex;gap:8px;flex-wrap:wrap}
    .pdf-btn{background:#dc3545;color:#fff;border:0;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:10px}
    .pdf-btn:hover{background:#c82333}

    /* ==== ADICIONES OPERATIVAS (NO CAMBIAN PDF) ==== */
    .no-print{ /* se oculta en impresi√≥n */ }

    .radio-group{display:flex;gap:20px;align-items:center;margin-top:5px;}
    .radio-group label{font-weight:normal;text-transform:none;display:flex;align-items:center;gap:5px;cursor:pointer;}
    .radio-group input[type="radio"]{cursor:pointer;}
    .series-info{background:#fff3cd;border:1px solid #ffc107;border-radius:4px;padding:8px;margin:8px 0;font-size:10px;color:#856404;}

    .service-autocomplete{position:relative;}
    .service-suggestions{
      position:absolute;top:100%;left:0;right:0;
      background:#fff;border:1px solid #1e5a3e;border-top:0;
      max-height:200px;overflow-y:auto;z-index:1000;display:none;
      box-shadow:0 4px 6px rgba(0,0,0,0.1);
    }
    .service-suggestions div{padding:6px 8px;cursor:pointer;font-size:10px;border-bottom:1px solid #eee;color:#333;}
    .service-suggestions div:hover{background:#f0f0f0;}
    .service-suggestions.show{display:block;}

    /* ==== IMPRESI√ìN: NO ALTERAR LAYOUT OT ==== */
    @media print{
      .nav-tabs,.excel-controls,.excel-mapping-info,.no-print{display:none !important;}
      .service-suggestions{display:none !important;} /* evita que se cuele el dropdown */
      body{background:#fff;padding:0;font-size:11px}
      .main-container{margin:0;max-width:none;padding:0}
      @page{size:A4;margin:10mm}

      /* Solo OT */
      #profileTab,#textTab,#documentsTab{display:none !important;}
      #workorderTab{display:block !important;}
    }
  </style>
</head>

<body>
<div class="main-container">

  <!-- Indicador -->
  <div id="syncIndicator" class="data-sync-indicator">‚úì Datos sincronizados</div>

  <!-- Tabs -->
  <div class="nav-tabs">
    <button class="nav-tab active" id="profileTabButton" onclick="switchTab('profile')">üë§ Perfil</button>
    <button class="nav-tab" id="workorderTabButton" onclick="switchTab('workorder')">üìã Orden de trabajo</button>
    <button class="nav-tab" id="textTabButton" onclick="switchTab('text')">üìù Textos</button>
    <button class="nav-tab" id="documentsTabButton" onclick="switchTab('documents')">üìÑ Documentos</button>
  </div>

  <!-- ================= TAB 1: PERFIL ================= -->
  <div id="profileTab" class="tab-content active">
    <div class="excel-controls">
      <strong>üìä Gesti√≥n de Perfil:</strong>
      <label class="file-input-label">üìÇ Examinar...
        <input type="file" id="profileFile" accept=".xlsx,.xls"/>
      </label>
      <span id="fileSelectedName" style="font-size:10px;color:#666;margin-right:10px;">No se ha seleccionado ning√∫n archivo.</span>
      <button onclick="loadProfile()">Cargar Perfil</button>
      <button onclick="saveProfile()">Guardar Perfil</button>
      <button onclick="downloadProfileTemplate()">Plantilla Perfil</button>
      <button onclick="exportToExcelFormat()">Exportar Formato Excel</button>
      <button onclick="sendToClient()">Enviar a Cliente</button>
      <span id="profileStatus"></span>
    </div>

    <div class="excel-mapping-info">
      <strong>üìä Mapeo Excel:</strong> Los datos se exportan con el formato est√°ndar de celdas. Para celdas combinadas, el sistema toma autom√°ticamente el valor de la celda izquierda superior.
    </div>

    <div class="header">
      <div class="logo-section">
        <div class="logo">EA</div>
        <div class="company-info">
          <h1>EJECUTIVA AMBIENTAL</h1>
          <p>SEGURIDAD E HIGIENE, CAPACITACI√ìN, MANTENIMIENTO INDUSTRIAL, PROTECCI√ìN CIVIL, MEDIO AMBIENTE</p>
        </div>
      </div>
      <div class="document-info">
        <h2>PERFIL DE DATOS DEL CLIENTE</h2>
        <p>Informaci√≥n General y Contacto</p>
      </div>
    </div>

    <!-- Info general -->
    <div class="section">
      <div class="section-header">Informaci√≥n General</div>
      <div class="section-content">
        <div class="form-grid">
          <div class="form-group"><label>Nombre y puesto solicitante</label><input type="text" id="requestorName" onchange="syncData()" data-excel="D3"></div>
          <div class="form-group"><label>Tel√©fono</label><input type="tel" id="requestorPhone" onchange="syncData()" data-excel="I7" placeholder="Tel√©fono de la empresa"></div>
          <div class="form-group full-width"><label>Denominaci√≥n/Raz√≥n Social</label><input type="text" id="companyName" onchange="syncData()" data-excel="D5"></div>
          <div class="form-group"><label>RFC</label><input type="text" id="rfc" onchange="syncData()" data-excel="D7"></div>
          <div class="form-group"><label>Sucursal</label><input type="text" id="branch" onchange="syncData()" placeholder="Ej: Sucursal Centro, Planta Norte"></div>
          <div class="form-group full-width"><label>Representante Legal</label><input type="text" id="legalRep" onchange="syncData()" data-excel="D9"></div>
          <div class="form-group full-width"><label>Direcci√≥n donde se evaluar√°</label><textarea id="evaluationAddress" onchange="syncData()" data-excel="D11"></textarea></div>
          <div class="form-group"><label>Responsable de atendernos</label><input type="text" id="contactPerson" onchange="syncData()" data-excel="D13"></div>
          <div class="form-group"><label>Tel√©fono</label><input type="tel" id="contactPhone" onchange="syncData()" data-excel="I13"></div>
          <div class="form-group full-width"><label>Giro</label><input type="text" id="businessType" onchange="syncData()" data-excel="D15"></div>
          <div class="form-group full-width"><label>Actividad Principal</label><textarea id="mainActivity" onchange="syncData()" data-excel="D17"></textarea></div>
          <div class="form-group"><label>Registro Patronal</label><input type="text" id="patronalRegistry" onchange="syncData()" data-excel="D19"></div>
          <div class="form-group"><label>Capacidad de Operaci√≥n</label><input type="text" id="operationCapacity" onchange="syncData()" data-excel="D21"></div>
          <div class="form-group"><label>Capacidad Instalada</label><input type="text" id="installedCapacity" onchange="syncData()" data-excel="I21"></div>
          <div class="form-group full-width"><label>D√≠as, turnos y horarios de trabajo</label><textarea id="workSchedule" onchange="syncData()" data-excel="D23"></textarea></div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Sobre el Informe de Resultados</div>
      <div class="section-content">
        <div class="form-grid">
          <div class="form-group"><label>Nombre de a quien se dirige</label><input type="text" id="reportRecipientName" onchange="syncData()" data-excel="D26"></div>
          <div class="form-group"><label>Puesto de a quien se dirige</label><input type="text" id="reportRecipientPosition" onchange="syncData()" data-excel="D28"></div>
          <div class="form-group full-width"><label>Correo a enviar el informe digital</label><input type="email" id="reportEmail" onchange="syncData()" data-excel="D30"></div>
        </div>
        <div class="form-group full-width">
          <label>Breve descripci√≥n del proceso operativo o productivo</label>
          <textarea id="processDescription" onchange="syncData()" style="min-height:100px;"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= TAB 2: ORDEN DE TRABAJO ================= -->
  <div id="workorderTab" class="tab-content">
    <div class="excel-controls">
      <strong>üîß Gesti√≥n de Orden:</strong>
      <button onclick="generateWorkOrder()">Generar desde Perfil</button>
      <button onclick="registerToSheets()" style="background:#007bff;">üìä Registrar en Sheets</button>
      <button onclick="saveWorkOrder()">Guardar Orden</button>
      <button onclick="printWorkOrder()">Imprimir/PDF</button>
      <button onclick="sendWorkOrder()">Enviar por Email</button>
      <span id="workorderStatus"></span>
    </div>

    <div class="header">
      <div class="logo-section">
        <div class="logo">EA</div>
        <div class="company-info">
          <h1>EJECUTIVA AMBIENTAL</h1>
          <p>SEGURIDAD E HIGIENE, CAPACITACI√ìN MANTENIMIENTO INDUSTRIAL, PROTECCI√ìN CIVIL, MEDIO AMBIENTE</p>
        </div>
      </div>
      <div class="document-info">
        <h2>ORDEN DE TRABAJO</h2>
        <p id="workOrderPageInfo">P√°gina 1 de 1</p>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Informaci√≥n del Servicio</div>
      <div class="section-content">
        <div class="form-grid">

          <!-- OPERATIVO: Serie OT/OTB (NO imprime) -->
          <div class="form-group full-width no-print">
            <label>Serie de Orden (Operativo)</label>
            <div class="radio-group">
              <label><input type="radio" name="orderSeries" value="OT" checked onchange="updateOrderNumber()"> Serie Normal (OT)</label>
              <label><input type="radio" name="orderSeries" value="OTB" onchange="updateOrderNumber()"> Serie B (OTB)</label>
            </div>
            <div class="series-info" id="seriesInfo">√öltimo: OT-000 | Siguiente sugerido: ...</div>
          </div>

          <div class="form-group"><label>N¬∞ de Orden de Servicio</label><input type="text" id="wo_orderNumber" placeholder="OT25-0106-001"></div>
          <div class="form-group"><label>Fecha de Emisi√≥n</label><input type="date" id="wo_issueDate"></div>
          <div class="form-group"><label>Referencia de Cotizaci√≥n</label><input type="text" id="wo_quoteRef"></div>
          <div class="form-group"><label><!-- vacio --></label><div></div></div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Informaci√≥n del Cliente (Auto-generada desde Perfil)</div>
      <div class="section-content">
        <div class="form-grid">
          <div class="form-group"><label>Nombre o Raz√≥n Social</label><input type="text" id="wo_clientName" readonly style="background:#e9ecef"></div>
          <div class="form-group"><label>Sucursal</label><input type="text" id="wo_branch" readonly style="background:#e9ecef"></div>
          <div class="form-group full-width"><label>Direcci√≥n del Servicio</label><input type="text" id="wo_serviceAddress" readonly style="background:#e9ecef"></div>
          <div class="form-group"><label>Responsable de atendernos</label><input type="text" id="wo_contactName" readonly style="background:#e9ecef"></div>
          <div class="form-group"><label>Tel√©fono</label><input type="tel" id="wo_phone" readonly style="background:#e9ecef"></div>
          <div class="form-group"><label>Email</label><input type="email" id="wo_email" placeholder="Editable - completar manualmente"></div>
        </div>
        <div class="form-group">
          <label>Destinatario del Informe</label>
          <div class="form-grid">
            <div class="form-group"><label>Nombre</label><input type="text" id="wo_reportTo" readonly style="background:#e9ecef"></div>
            <div class="form-group"><label>Puesto</label><input type="text" id="wo_reportPosition" readonly style="background:#e9ecef"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Desarrollo del Trabajo</div>
      <div class="section-content">
        <table class="work-table" id="workTable">
          <thead>
          <tr>
            <!-- ANCHOS ORIGINALES (inamovibles) -->
            <th style="width:15%">SERVICIO</th>
            <th style="width:15%">PERSONAL ASIGNADO</th>
            <th style="width:15%">FECHA</th>
            <th style="width:15%">CANTIDAD</th>
            <th style="width:38%">OBSERVACIONES</th>
            <th style="width:2%"></th>
          </tr>
          </thead>
          <tbody id="workTableBody">
          <tr>
            <td>
              <!-- Autocomplete NO cambia impresi√≥n -->
              <div class="service-autocomplete">
                <input type="text" class="service-input" placeholder="NOM-XXX-STPS">
                <div class="service-suggestions"></div>
              </div>
            </td>
            <td>
              <select>
                <option value="">Seleccionar...</option>
                <option>Mart√≠n Luna</option>
                <option>Jimmy Ayala</option>
                <option>Iv√°n Z√°rate</option>
                <option>Gonzalo Torres</option>
                <option>Eduardo Campos</option>
                <option>Adri√°n H</option>
                <option>Externo</option>
              </select>
            </td>
            <td><input type="date"></td>
            <td><input type="text" placeholder="5 dosis, 10 RSP, etc..."></td>
            <td><textarea rows="2"></textarea></td>
            <td style="text-align:center;"><button class="remove-row-btn" onclick="removeRow(this)">‚úñ</button></td>
          </tr>
          </tbody>
        </table>
        <button class="add-row-btn" onclick="addWorkRow()">+ Agregar Fila</button>

        <div class="form-group full-width" style="margin-top:15px;">
          <label>Observaciones Generales</label>
          <textarea id="wo_generalObservations" style="min-height:80px;" placeholder="üìã RECORDATORIO: Portar EPP..."></textarea>
        </div>
      </div>
    </div>

    <!-- FIRMAS + QR: BLOQUE ORIGINAL (inamovible) -->
    <div class="section">
      <div class="section-header">Autorizaci√≥n y Firmas</div>
      <div class="section-content">
        <div class="form-grid">
          <div class="form-group"><label>Realiz√≥</label><input type="text" id="wo_preparedBy" placeholder="Nombre de quien elabor√≥"></div>
          <div class="form-group"><label>Autoriz√≥</label><input type="text" id="wo_authorizedBy" value="ING. EDUWIN IV√ÅN HERN√ÅNDEZ Z√ÅRATE - DIRECTOR" readonly style="background:#e9ecef"></div>
        </div>
        <div class="form-group full-width" style="margin-top:20px;padding:15px;border:1px solid #ddd;border-radius:4px;background:#f8f9fa;">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;">
            <div style="flex:2;margin-right:20px;">
              <label style="font-weight:bold;color:#1e5a3e;">Firma del Cliente</label>
              <p style="margin:10px 0;font-style:italic;font-size:11px;">"He recibido visita del proveedor para la realizaci√≥n de los servicios se√±alados en la presente orden."</p>
              <div style="margin-top:30px;border-bottom:1px solid #333;width:70%;display:inline-block;"></div>
              <p style="margin:5px 0;font-size:10px;">Firma y Nombre del Cliente</p>
            </div>
            <div style="flex:1;text-align:center;">
              <div id="qrCodeContainer" style="text-align:center;padding:10px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ================= TAB 3: GENERADOR DE TEXTOS ================= -->
  <div id="textTab" class="tab-content">
    <div class="excel-controls">
      <strong>üìù Generador de Textos:</strong>
      <button onclick="generateTextFromProfile()">Auto-completar desde Perfil</button>
      <button onclick="copyTextToClipboard()">Copiar Texto</button>
      <span id="textStatus"></span>
    </div>

    <div class="section">
      <div class="section-header">Seleccionar Tipo de Texto</div>
      <div class="section-content">
        <div class="template-grid">
          <div class="template-card" onclick="selectTextTemplate('email_profile', this)">
            <h4>üìß Email - Solicitud de Perfil</h4>
            <p>Para solicitar datos del cliente</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('email_workorder', this)">
            <h4>üìß Email - Orden de Trabajo</h4>
            <p>Env√≠o de orden con detalles</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('email_followup', this)">
            <h4>üìß Email - Seguimiento</h4>
            <p>Recordatorio y coordinaci√≥n</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('email_quote', this)">
            <h4>üìß Email - Cotizaci√≥n</h4>
            <p>Env√≠o de presupuesto</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('email_results', this)">
            <h4>üìß Email - Resultados</h4>
            <p>Entrega de informe final</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('receipt', this)">
            <h4>üí∞ Recibo de Pago</h4>
            <p>Comprobante de pago membretado</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('status_letter', this)">
            <h4>üìÑ Carta Estatus</h4>
            <p>Estado del servicio o proyecto</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('memo', this)">
            <h4>üìù Memor√°ndum</h4>
            <p>Comunicaci√≥n interna</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('invoice', this)">
            <h4>üìã Datos bancarios</h4>
            <p>Documento de facturaci√≥n</p>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Texto Generado</div>
      <div class="section-content">
        <div class="text-output" id="textOutput">Selecciona un tipo de texto para generar el contenido...</div>
        <button class="copy-btn" onclick="copyTextToClipboard()">üìã Copiar al Portapapeles</button>
      </div>
    </div>
  </div>

  <!-- ================= TAB 4: DOCUMENTOS PDF ================= -->
  <div id="documentsTab" class="tab-content">
    <div class="excel-controls">
      <strong>üìÑ Generador de Documentos:</strong>
      <button onclick="generateDocumentData()">Auto-completar desde Perfil</button>
      <span id="documentsStatus"></span>
    </div>

    <div class="section">
      <div class="section-header">Documentos Disponibles</div>
      <div class="section-content">
        <div class="document-grid">
          <div class="document-card">
            <h4>üèõÔ∏è Carta Poder STPS</h4>
            <p>Documento oficial para la Secretar√≠a del Trabajo y Previsi√≥n Social</p>
            <div class="document-actions">
              <button class="pdf-btn" onclick="generateSTPS()">Auto-completar</button>
              <button class="pdf-btn" onclick="downloadSTPS()">Descargar PDF</button>
            </div>
          </div>

          <div class="document-card">
            <h4>üìã Carta de Servicios</h4>
            <p>Documento que certifica los servicios realizados</p>
            <div class="document-actions">
              <button class="pdf-btn" onclick="generateServiceLetter()">Generar</button>
              <button class="pdf-btn" onclick="downloadServiceLetter()">Descargar PDF</button>
            </div>
          </div>

          <div class="document-card">
            <h4>üìÑ Constancia de Cumplimiento</h4>
            <p>Certificado de cumplimiento normativo</p>
            <div class="document-actions">
              <button class="pdf-btn" onclick="generateComplianceLetter()">Generar</button>
              <button class="pdf-btn" onclick="downloadComplianceLetter()">Descargar PDF</button>
            </div>
          </div>

          <div class="document-card">
            <h4>üìù Acta de Reuni√≥n</h4>
            <p>Documento de minuta de reuni√≥n t√©cnica</p>
            <div class="document-actions">
              <button class="pdf-btn" onclick="generateMeetingAct()">Generar</button>
              <button class="pdf-btn" onclick="downloadMeetingAct()">Descargar PDF</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Carta Poder STPS -->
    <div class="section" id="stpsSection">
      <div class="section-header">Configuraci√≥n - Carta Poder STPS</div>
      <div class="section-content">
        <div class="form-grid">
          <div class="form-group full-width">
            <label>L√≠nea 2 (Dependencia)</label>
            <input type="text" id="stps_officeLine2" value="OFICINA DE REPRESENTACI√ìN FEDERAL DEL TRABAJO EN EL ESTADO DE PUEBLA CON SEDE EN PUEBLA">
          </div>
          <div class="form-group full-width">
            <label>L√≠nea 3 (Domicilio)</label>
            <input type="text" id="stps_officeLine3" value="EDIFICIO SELAFE, AV. 31 PONIENTE NO. 2904, P.B., COL. EL VERGEL, C.P. 72400, PUEBLA, PUEBLA">
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group full-width">
            <label>Selecciona una o varias personas autorizadas</label>
            <div>
              <label><input type="checkbox" class="authCheck" value="Gonzalo Eli Torres Quiroz"> Gonzalo Eli Torres Quiroz</label><br/>
              <label><input type="checkbox" class="authCheck" value="Eduwin Iv√°n Hern√°ndez Z√°rate"> Eduwin Iv√°n Hern√°ndez Z√°rate</label><br/>
              <label><input type="checkbox" class="authCheck" value="Jimmy Jeynson Ayala Borrallez"> Jimmy Jeynson Ayala Borrallez</label><br/>
              <label><input type="checkbox" class="authCheck" value="Mart√≠n Luna C√≥rdova"> Mart√≠n Luna C√≥rdova</label>
            </div>
            <div style="margin-top:8px;">
              <label>Otro (editable):</label>
              <input type="text" id="stps_otherName" placeholder="Escribe otro nombre completo">
            </div>

            <div class="form-group full-width">
              <label>Lista final (puedes editar manualmente)</label>
              <textarea id="stps_authorizedPersons" style="min-height:70px;" placeholder="Nombres completos separados por comas"></textarea>
            </div>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group"><label>Testigo 1</label><input type="text" id="stps_witness1" placeholder="Nombre completo del testigo 1"></div>
          <div class="form-group"><label>Testigo 2</label><input type="text" id="stps_witness2" placeholder="Nombre completo del testigo 2"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ========= LIBRER√çAS ========= -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- ========= SCRIPT PRINCIPAL ========= -->
<script>
// ================== CONFIG GOOGLE SHEETS (OPERATIVO) ==================
  const SHEETS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbypj4AfQxsvRLl_bMOLZtiNS55c7Sw4-bfwpyw77FZ85EM_qQqYBC3dhjEqCsprCoX1gA/exec';
  const SPREADSHEET_ID = '1pWIzrtLAh_YHow1LH55tIfgsCUoct-64JjPaBk5u10U';
  const SHEET_NAME = 'PANEL2.0';
  const START_ROW = 2; // Ajustado a tu configuraci√≥n real

  const PREDEFINED_SERVICES = [
    'NOM-001-STPS','NOM-002-STPS','NOM-004-STPS','NOM-006-STPS','NOM-011-STPS',
    'NOM-015-STPS','NOM-017-STPS','NOM-019-STPS','NOM-022-STPS','NOM-024-STPS',
    'NOM-025-STPS','NOM-026-STPS','NOM-030-STPS','NOM-081-SEMARNAT','PROTECCI√ìN CIVIL',
    'CAPACITACI√ìN','DICTAMEN ESTRUCTURAL','ESTUDIO DE RIESGO','PLAN DE EMERGENCIA','PROGRAMA INTERNO'
  ];

  // ================== VARIABLES GLOBALES ==================
  let profileData = {};
  let workOrderData = {};
  let selectedTextTemplate = null;

  const excelCellMapping = {
    'requestorName':'D3','companyName':'D5','rfc':'D7','requestorPhone':'I7','legalRep':'D9',
    'evaluationAddress':'D11','contactPerson':'D13','contactPhone':'I13','businessType':'D15',
    'mainActivity':'D17','patronalRegistry':'D19','operationCapacity':'D21','installedCapacity':'I21',
    'workSchedule':'D23','reportRecipientName':'D26','reportEmail':'D30','reportRecipientPosition':'D28'
  };

  // ================== UTILIDADES ==================
  function getCellValue(ws, cellRef) {
    try {
      const c = ws[cellRef];
      return (c && c.v !== undefined) ? c.v : '';
    } catch(e) {
      return '';
    }
  }

  function setCellValue(ws, cellRef, value) {
    try {
      if (value !== undefined && value !== null && value !== '') {
        ws[cellRef] = {v: value, t: 's'};
      }
    } catch(e) {
      console.error('Error setting cell value:', e);
    }
  }

  function showStatus(elementId, message, type = 'success') {
    const element = document.getElementById(elementId);
    if (!element) return;
    element.innerHTML = `<span class="status-message status-${type}">${message}</span>`;
    setTimeout(() => { element.innerHTML = ''; }, 3000);
  }

  function showSyncIndicator() {
    const el = document.getElementById('syncIndicator');
    if (el) {
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2000);
    }
  }

  function copyToClipboard(text) {
    if (navigator.clipboard) {
      navigator.clipboard.writeText(text).catch(()=>{});
    } else {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
  }

  // ================== TABS ==================
  function switchTab(name) {
    try { window.scrollTo({top:0, behavior:'smooth'}); } catch(e) { window.scrollTo(0,0); }
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

    const tabMap = {
      'profile': { content: 'profileTab', button: 'profileTabButton' },
      'workorder': { content: 'workorderTab', button: 'workorderTabButton' },
      'text': { content: 'textTab', button: 'textTabButton' },
      'documents': { content: 'documentsTab', button: 'documentsTabButton' }
    };

    if (tabMap[name]) {
      const contentEl = document.getElementById(tabMap[name].content);
      const buttonEl = document.getElementById(tabMap[name].button);
      if (contentEl) contentEl.classList.add('active');
      if (buttonEl) buttonEl.classList.add('active');
    }

    // siempre sincroniza al cambiar (no afecta impresi√≥n)
    syncData();
  }

  // ================== SINCRONIZACI√ìN PERFIL -> OT ==================
  function syncData() {
    const fields = [
      'requestorName','requestorPhone','companyName','rfc','branch','legalRep',
      'evaluationAddress','contactPerson','contactPhone','businessType','mainActivity',
      'patronalRegistry','operationCapacity','installedCapacity','workSchedule',
      'reportRecipientName','reportRecipientPosition','reportEmail','processDescription'
    ];

    fields.forEach(id => {
      const el = document.getElementById(id);
      if (el) profileData[id] = el.value;
    });

    updateWorkOrderFromProfile();
    showSyncIndicator();
  }

  function updateWorkOrderFromProfile() {
    const map = {
      'companyName': 'wo_clientName',
      'branch': 'wo_branch',
      'evaluationAddress': 'wo_serviceAddress',
      'contactPerson': 'wo_contactName',
      'contactPhone': 'wo_phone',
      'reportEmail': 'wo_email',
      'reportRecipientName': 'wo_reportTo',
      'reportRecipientPosition': 'wo_reportPosition'
    };

    Object.keys(map).forEach(k => {
      const v = profileData[k] || '';
      const f = document.getElementById(map[k]);
      if (f) f.value = v;
    });
  }

  // ================== PERFIL (EXCEL) ==================
  function loadProfile() {
    const input = document.getElementById('profileFile');
    const file = input?.files[0];
    if (!file) { showStatus('profileStatus','Selecciona un archivo Excel','warning'); return; }

    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        populateProfileFromExcel(ws);
        showStatus('profileStatus','Perfil cargado exitosamente','success');
      } catch(err) {
        console.error(err);
        showStatus('profileStatus','Error al leer archivo Excel','error');
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function populateProfileFromExcel(ws) {
    Object.keys(excelCellMapping).forEach(id => {
      const ref = excelCellMapping[id];
      const val = getCellValue(ws, ref);
      const el = document.getElementById(id);
      if (el && val !== '') el.value = String(val);
    });
    syncData();
  }

  function saveProfile() {
    try {
      const wb = XLSX.utils.book_new();
      const wsData = {};
      Object.keys(excelCellMapping).forEach(id => {
        const el = document.getElementById(id);
        const ref = excelCellMapping[id];
        if (el && el.value) setCellValue(wsData, ref, el.value);
      });

      const ws = XLSX.utils.json_to_sheet([]);
      Object.keys(wsData).forEach(r => ws[r] = wsData[r]);
      XLSX.utils.book_append_sheet(wb, ws, "Perfil_Cliente");

      const name = (profileData.companyName || 'Cliente').replace(/[^a-zA-Z0-9]/g, '_');
      const fileName = `Perfil_${name}_${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, fileName);
      showStatus('profileStatus','Perfil guardado correctamente','success');
    } catch(err) {
      console.error(err);
      showStatus('profileStatus','Error al guardar perfil','error');
    }
  }

  function downloadProfileTemplate() {
    try {
      const wb = XLSX.utils.book_new();
      const data = {};
      const examples = {
        'D3': 'Juan P√©rez - Gerente',
        'D5': 'Empresa Ejemplo S.A. de C.V.',
        'D7': 'EEJ123456ABC',
        'I7': '222-123-4567',
        'D9': 'Mar√≠a Gonz√°lez',
        'D11': 'Av. Principal 123, Puebla, Pue.',
        'D13': 'Ana Mart√≠nez',
        'I13': '222-987-6543',
        'D15': 'Manufactura Industrial',
        'D17': 'Fabricaci√≥n de met√°licos',
        'D19': 'RP-12345-2023',
        'D21': '1000 u/d√≠a',
        'I21': '1500 u/d√≠a',
        'D23': 'L-V 7:00-15:00',
        'D26': 'Ing. Carlos Ruiz',
        'D28': 'Director T√©cnico',
        'D30': 'gerencia@empresa.com'
      };
      Object.keys(examples).forEach(r => setCellValue(data, r, examples[r]));

      const ws = XLSX.utils.json_to_sheet([]);
      Object.keys(data).forEach(r => ws[r] = data[r]);
      XLSX.utils.book_append_sheet(wb, ws, "Plantilla");
      XLSX.writeFile(wb, "Plantilla_Perfil_Cliente_EA.xlsx");
      showStatus('profileStatus','Plantilla descargada correctamente','success');
    } catch(err) {
      console.error(err);
      showStatus('profileStatus','Error al generar plantilla','error');
    }
  }

  function exportToExcelFormat() { saveProfile(); }

  function sendToClient() {
    const email = document.getElementById('reportEmail')?.value;
    const company = document.getElementById('companyName')?.value || 'Su Empresa';
    if (!email) { showStatus('profileStatus','Ingresa un email de contacto primero','warning'); return; }

    const subject = `Perfil de Datos - ${company} - Ejecutiva Ambiental`;
    const body = `Estimado cliente,

Adjunto encontrar√° la plantilla del Perfil de Datos para completar con la informaci√≥n de su empresa.

Saludos cordiales,
Ejecutiva Ambiental`;

    window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    showStatus('profileStatus','Cliente de email abierto','success');
  }

  // ================== SERIES OT/OTB (OPERATIVO, NO PDF) ==================
  function getSelectedSeries() {
    const radio = document.querySelector('input[name="orderSeries"]:checked');
    return radio ? radio.value : 'OT';
  }
  function getLastOrderNumber(series) {
    return localStorage.getItem(`lastOrder_${series}`) || `${series}-000`;
  }
  function saveLastOrderNumber(series, orderNumber) {
    localStorage.setItem(`lastOrder_${series}`, orderNumber);
  }
  function generateNextOrderNumber(series) {
    const lastOrder = getLastOrderNumber(series);
    const parts = lastOrder.split('-');
    const lastNum = parseInt(parts[parts.length - 1], 10) || 0;
    const nextNum = lastNum + 1;

    const today = new Date();
    const yy = String(today.getFullYear()).slice(-2);
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    return `${series}${yy}-${mm}${dd}-${String(nextNum).padStart(3, '0')}`;
  }
  function updateOrderNumber() {
    const series = getSelectedSeries();
    const lastOrder = getLastOrderNumber(series);
    const nextOrder = generateNextOrderNumber(series);

    const infoBox = document.getElementById('seriesInfo');
    if (infoBox) infoBox.textContent = `√öltimo: ${lastOrder} | Siguiente sugerido: ${nextOrder}`;

    const orderInput = document.getElementById('wo_orderNumber');
    if (orderInput) orderInput.value = nextOrder;
  }

  // ================== AUTOCOMPLETADO SERVICIOS ==================
  function setupServiceAutocomplete(input) {
    if (!input) return;
    const container = input.closest('.service-autocomplete');
    if (!container) return;

    const suggestionsDiv = container.querySelector('.service-suggestions');
    if (!suggestionsDiv) return;

    input.addEventListener('input', function() {
      const value = this.value.toUpperCase().trim();
      if (value.length < 2) { suggestionsDiv.classList.remove('show'); return; }

      const filtered = PREDEFINED_SERVICES.filter(s => s.toUpperCase().includes(value));
      if (filtered.length) {
        suggestionsDiv.innerHTML = filtered.map(s => `<div data-service="${s}">${s}</div>`).join('');
        suggestionsDiv.classList.add('show');
      } else {
        suggestionsDiv.classList.remove('show');
      }
    });

    suggestionsDiv.addEventListener('click', (e) => {
      const item = e.target.closest('div[data-service]');
      if (!item) return;
      input.value = item.getAttribute('data-service') || '';
      suggestionsDiv.classList.remove('show');
    });

    document.addEventListener('click', (e) => {
      if (!container.contains(e.target)) suggestionsDiv.classList.remove('show');
    }, {capture:true});
  }

  // ================== OT ==================
  function generateWorkOrder() {
    const today = new Date();
    const dateInput = document.getElementById('wo_issueDate');
    if (dateInput) dateInput.value = today.toISOString().split('T')[0];

    // Folio por serie (operativo)
    updateOrderNumber();

    syncData();
    generateQRCode();
    showStatus('workorderStatus','Orden de trabajo generada autom√°ticamente','success');
  }

  function generateQRCode() {
    const cont = document.getElementById('qrCodeContainer');
    if (!cont) return;

    cont.innerHTML = '';
    const img = document.createElement('img');
    img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=tel:2229417295';
    img.alt = 'Llamar al 2229417295';
    img.style.cssText = 'width:80px;height:80px;border:1px solid #ccc;border-radius:4px;';
    cont.appendChild(img);

    const txt = document.createElement('div');
    txt.textContent = 'Dudas: 2229417295';
    txt.style.cssText = 'font-size:8px;text-align:center;margin-top:2px;';
    cont.appendChild(txt);
  }

  function addWorkRow() {
    const tbody = document.getElementById('workTableBody');
    if (!tbody) return;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <div class="service-autocomplete">
          <input type="text" class="service-input" placeholder="NOM-XXX-STPS">
          <div class="service-suggestions"></div>
        </div>
      </td>
      <td>
        <select>
          <option value="">Seleccionar...</option>
          <option>Mart√≠n Luna</option>
          <option>Jimmy Ayala</option>
          <option>Iv√°n Z√°rate</option>
          <option>Gonzalo Torres</option>
          <option>Eduardo Campos</option>
          <option>Adri√°n H</option>
          <option>Externo</option>
        </select>
      </td>
      <td><input type="date"></td>
      <td><input type="text" placeholder="Ruido, Vibraci√≥n, etc."></td>
      <td><textarea rows="2"></textarea></td>
      <td style="text-align:center;"><button class="remove-row-btn" onclick="removeRow(this)">‚úñ</button></td>
    `;
    tbody.appendChild(tr);

    setupServiceAutocomplete(tr.querySelector('.service-input'));
  }

  function removeRow(btn) {
    if (btn && btn.closest) btn.closest('tr').remove();
  }

  function saveWorkOrder() {
    try {
      const orderNumber = document.getElementById('wo_orderNumber')?.value || 'Nueva';
      const issueDate = document.getElementById('wo_issueDate')?.value || '';
      const quoteRef = document.getElementById('wo_quoteRef')?.value || '';

      // Guardar √∫ltimo folio por serie (operativo)
      saveLastOrderNumber(getSelectedSeries(), orderNumber);
      updateOrderNumber();

      const data = {
        'Numero_Orden': orderNumber,
        'Fecha_Emision': issueDate,
        'Referencia_Cotizacion': quoteRef,
        'Cliente': document.getElementById('wo_clientName')?.value || '',
        'Sucursal': document.getElementById('wo_branch')?.value || '',
        'Direccion_Servicio': document.getElementById('wo_serviceAddress')?.value || '',
        'Responsable_Atencion': document.getElementById('wo_contactName')?.value || '',
        'Telefono': document.getElementById('wo_phone')?.value || '',
        'Email': document.getElementById('wo_email')?.value || '',
        'Destinatario_Informe': document.getElementById('wo_reportTo')?.value || '',
        'Puesto_Destinatario': document.getElementById('wo_reportPosition')?.value || '',
        'Observaciones_Generales': document.getElementById('wo_generalObservations')?.value || '',
        'Realizo': document.getElementById('wo_preparedBy')?.value || '',
        'Autorizo': document.getElementById('wo_authorizedBy')?.value || ''
      };

      const items = [];
      const workRows = document.querySelectorAll('#workTableBody tr');
      workRows.forEach((row, i) => {
        const fields = row.querySelectorAll('input, select, textarea');
        if (fields.length >= 5 && fields[0].value) {
          items.push({
            'Item': i + 1,
            'Norma': fields[0].value,
            'Personal_Asignado': fields[1].value,
            'Fecha': fields[2].value,
            'Cantidad': fields[3].value,
            'Observaciones': fields[4].value
          });
        }
      });

      const wb = XLSX.utils.book_new();
      const wsG = XLSX.utils.json_to_sheet([data]);
      XLSX.utils.book_append_sheet(wb, wsG, "Datos_Generales");

      if (items.length) {
        const wsW = XLSX.utils.json_to_sheet(items);
        XLSX.utils.book_append_sheet(wb, wsW, "Detalle_Trabajo");
      }

      const fileName = `Orden_Trabajo_${orderNumber}_${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, fileName);

      showStatus('workorderStatus','Orden de trabajo guardada','success');
    } catch(err) {
      console.error(err);
      showStatus('workorderStatus','Error al guardar orden','error');
    }
  }

  // PRINT: FUNCI√ìN ORIGINAL (fuerza vista solo OT y conserva layout)
  function printWorkOrder() {
    const orderNumber = document.getElementById('wo_orderNumber')?.value || 'OT';
    const client = document.getElementById('wo_clientName')?.value || 'Cliente';
    document.title = `${orderNumber} - ${client}`;

    const controls = document.querySelectorAll('.excel-controls, .nav-tabs, .excel-mapping-info');
    controls.forEach(e => e.style.display = 'none');

    // Ocultar otras pesta√±as
    document.getElementById('profileTab').style.display = 'none';
    document.getElementById('textTab').style.display = 'none';
    document.getElementById('documentsTab').style.display = 'none';
    document.getElementById('workorderTab').style.display = 'block';

    window.print();

    setTimeout(() => {
      controls.forEach(e => e.style.display = '');
      document.getElementById('profileTab').style.display = '';
      document.getElementById('textTab').style.display = '';
      document.getElementById('documentsTab').style.display = '';
      switchTab('workorder');
      document.title = 'Sistema Ejecutiva Ambiental - Perfil de Datos & Orden de Trabajo';
    }, 800);
  }

  function sendWorkOrder() {
    const email = document.getElementById('wo_email')?.value;
    const orderNumber = document.getElementById('wo_orderNumber')?.value || 'Nueva';

    if (!email) {
      showStatus('workorderStatus','No hay email de cliente disponible','warning');
      return;
    }

    const cc = 'eduwin.ejecutiva@gmail.com';
    const branch = profileData.branch || 'No especificada';
    const installed = profileData.installedCapacity || 'No especificada';
    const operation = profileData.operationCapacity || 'No especificada';
    const patronal = profileData.patronalRegistry || 'No especificado';
    const giro = profileData.businessType || 'No especificado';
    const company = profileData.companyName || 'Cliente';
    const address = profileData.evaluationAddress || '';
    const maps = address ? `https://maps.google.com/maps?q=${encodeURIComponent(address.trim())}` : 'Direcci√≥n no disponible';

    const subject = `Orden de Trabajo ${orderNumber} - ${company} - Ejecutiva Ambiental`;
    const body = `Estimado,

Adjunto encontrar√° la Orden de Trabajo ${orderNumber} para los servicios programados.

üè¢ Raz√≥n Social: ${company}
‚Ä¢ Sucursal: ${branch}
‚Ä¢ Giro/Actividad: ${giro}
‚Ä¢ Registro Patronal: ${patronal}

‚öôÔ∏è Capacidad Instalada: ${installed}
‚öôÔ∏è Capacidad de Operaci√≥n: ${operation}

üìç Direcci√≥n: ${address}
üîó Google Maps: ${maps}

Saludos cordiales,
Ejecutiva Ambiental
Tel: 222-941-7295`;

    window.location.href = `mailto:${email}?cc=${cc}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    showStatus('workorderStatus',`Email preparado con copia a ${cc}`,'success');
  }


// ================== REGISTRO A SHEETS (OPERATIVO) ==================
async function registerToSheets() {
  try {
    showStatus('workorderStatus','Registrando en Sheets...','warning');

    const orderNumber = document.getElementById('wo_orderNumber')?.value || '';
    const company = document.getElementById('wo_clientName')?.value || '';
    const branch = document.getElementById('wo_branch')?.value || '';

    const services = [], personnel = [], dates = [];
    const workRows = document.querySelectorAll('#workTableBody tr');
    workRows.forEach(row => {
      const fields = row.querySelectorAll('input, select, textarea');
      if (fields.length >= 3 && fields[0].value) {
        services.push((fields[0].value || '').trim());
        personnel.push((fields[1].value || '').trim());
        dates.push((fields[2].value || '').trim());
      }
    });

    const payload = {
      orderNumber,
      companyBranch: branch ? `${company} - ${branch}` : company,
      services: services.join(', '),
      personnel: personnel.join(', '),
      dates: dates.join(', '),
      startRow: START_ROW // 93 en tu config
    };

    // IMPORTANTE:
    // - Mant√©n mode:'no-cors' (porque Apps Script no da CORS headers)
    // - PERO el Content-Type debe ser text/plain para que el body llegue.
    await fetch(SHEETS_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });

    // No podemos leer respuesta por no-cors; asumimos que se envi√≥.
    saveLastOrderNumber(getSelectedSeries(), orderNumber);
    updateOrderNumber();

    showStatus('workorderStatus','‚úÖ Enviado a Sheets (webhook) y folio actualizado','success');
  } catch (e) {
    console.error(e);
    showStatus('workorderStatus','‚ùå Error al enviar a Sheets','error');
  }
}


  // ================== TEXTOS ==================
  function generateTextFromProfile() {
    if (selectedTextTemplate) {
      selectTextTemplate(selectedTextTemplate);
    } else {
      const first = document.querySelector('.template-card');
      selectTextTemplate('email_profile', first);
    }
    showStatus('textStatus','Texto auto-completado desde el perfil','success');
  }

  function selectTextTemplate(type, el) {
    selectedTextTemplate = type;
    document.querySelectorAll('.template-card').forEach(n => n.classList.remove('selected'));
    if (el) el.classList.add('selected');

    const company = profileData.companyName || 'Cliente';
    const order = document.getElementById('wo_orderNumber')?.value || 'Nueva';
    const branch = profileData.branch || 'No especificada';
    const address = profileData.evaluationAddress || '';
    const maps = address ? `https://maps.google.com/maps?q=${encodeURIComponent(address.trim())}` : 'Direcci√≥n no disponible';
    const contact = profileData.contactPerson || '';
    const phone = profileData.contactPhone || '';
    const email = profileData.reportEmail || '';
    const currentDate = new Date().toLocaleDateString('es-MX');

    let text = '';

    switch (type) {
      case 'email_profile':
        text = `Para: ${email}
CC: eduwin.ejecutiva@gmail.com
Asunto: Solicitud de Perfil de Datos - ${company} - Ejecutiva Ambiental

Estimado cliente,

Para brindarle el mejor servicio, necesitamos completar su perfil de datos empresariales.

Favor de enviar la informaci√≥n completa a este correo.

Saludos cordiales,
EJECUTIVA AMBIENTAL
Tel: 222-941-7295`;
        break;

      case 'email_workorder':
        text = `Para: ${email}
CC: eduwin.ejecutiva@gmail.com
Asunto: Orden de Trabajo ${order} - ${company} - Ejecutiva Ambiental

Estimado cliente,

Adjunto encontrar√° la Orden de Trabajo ${order} para los servicios programados.

‚Ä¢ Empresa: ${company}
‚Ä¢ Sucursal: ${branch}
‚Ä¢ Fecha de emisi√≥n: ${currentDate}

Direcci√≥n:
${address}
Google Maps: ${maps}

Saludos cordiales,
EJECUTIVA AMBIENTAL`;
        break;

      case 'email_followup':
        text = `Para: ${email}
CC: eduwin.ejecutiva@gmail.com
Asunto: Seguimiento de Servicio - ${company} - Ejecutiva Ambiental

Estimado cliente,

Damos seguimiento a los servicios programados para su empresa.

Saludos cordiales,
EJECUTIVA AMBIENTAL`;
        break;

      case 'email_quote':
        text = `Para: ${email}
CC: eduwin.ejecutiva@gmail.com
Asunto: Cotizaci√≥n de Servicios - ${company} - Ejecutiva Ambiental

Estimado cliente,

Adjunto encontrar√° la cotizaci√≥n solicitada.

Saludos cordiales,
EJECUTIVA AMBIENTAL`;
        break;

      case 'email_results':
        text = `Para: ${email}
CC: eduwin.ejecutiva@gmail.com
Asunto: Entrega de Resultados - ${company} - Ejecutiva Ambiental

Estimado cliente,

Hacemos entrega de los resultados correspondientes a la orden ${order}.

Saludos cordiales,
EJECUTIVA AMBIENTAL`;
        break;

      case 'receipt':
        text = `ASUNTO: RECEPCI√ìN DE PAGO

RECIBO DE PAGO

Lugar y fecha: Puebla, Pue., a ${currentDate}

A QUIEN CORRESPONDA:

Por medio del presente documento, se deja constancia de que SOLUCI√ìN EN INGENIER√çA EJECUTIVA AMBIENTAL S.A. DE C.V., con domicilio en CHIPILO 714, COLONIA LA PAZ, PUEBLA, Pue., ha recibido a entera satisfacci√≥n el pago por parte de:

Nombre o Raz√≥n Social del Cliente: ${company}
Monto recibido: ABIERTO
Forma de pago: Efectivo
Fecha del pago: ${currentDate}

Este recibo no sustituye el CFDI.`;
        break;

      case 'status_letter':
        text = `A QUIEN CORRESPONDA,

Por medio de la presente hago de su conocimiento que la empresa con raz√≥n social ${company}, ubicada en ${address}, ha contratado nuestros servicios.

Fecha: ${currentDate}`;
        break;

      case 'memo':
        text = `EJECUTIVA AMBIENTAL
MEMOR√ÅNDUM

FECHA: ${currentDate}
PARA: TODO EL PERSONAL
DE: DIRECCI√ìN GENERAL
ASUNTO: [ESPECIFICAR]

DISPOSICIONES:
1. _________________________________

ATENTAMENTE
ING. EDUWIN IV√ÅN HERN√ÅNDEZ Z√ÅRATE
DIRECTOR GENERAL`;
        break;

      case 'invoice':
        text = `DATOS BANCARIOS

CLIENTE: ${company}
RFC: ${profileData.rfc || '[RFC CLIENTE]'}
Direcci√≥n: ${address}
Contacto: ${contact}
Tel√©fono: ${phone}

Beneficiario: SOLUCI√ìN EN INGENIER√çA EJECUTIVA AMBIENTAL S.A. DE C.V.
Banco: BBVA
RFC: SIE240503N89
CLABE: 012650001233239784

Agradeceremos incluir el n√∫mero de cotizaci√≥n o factura en el motivo de transferencia.`;
        break;
    }

    const output = document.getElementById('textOutput');
    if (output) output.textContent = text;
  }

  function copyTextToClipboard() {
    const output = document.getElementById('textOutput');
    if (output && output.textContent) {
      copyToClipboard(output.textContent);
      showStatus('textStatus','Texto copiado al portapapeles','success');
    } else {
      showStatus('textStatus','No hay texto para copiar','warning');
    }
  }

  // ================== DOCUMENTOS PDF ==================
  function generateDocumentData() {
    showStatus('documentsStatus','Datos auto-completados desde el perfil','success');
  }

  function composeAuthorizedList() {
    const checks = [...document.querySelectorAll('.authCheck')]
      .filter(c => c.checked)
      .map(c => c.value);

    const other = document.getElementById('stps_otherName')?.value.trim();
    if (other) checks.push(other);

    const list = checks.join(', ');
    const ta = document.getElementById('stps_authorizedPersons');
    if (ta && !ta.value.trim()) ta.value = list;
  }

  function generateSTPS() {
    composeAuthorizedList();
    showStatus('documentsStatus','Carta Poder STPS auto-completada','success');
  }

  async function downloadSTPS() {
    try {
      const { jsPDF } = window.jspdf;

      const currentDate = new Date();
      const dateString = currentDate.toLocaleDateString('es-MX', { day:'numeric', month:'long', year:'numeric' });
      const year = currentDate.getFullYear();

      const authorizedPersons = document.getElementById('stps_authorizedPersons')?.value || '[PERSONA(S) AUTORIZADA(S)]';
      const witness1 = document.getElementById('stps_witness1')?.value || '[TESTIGO 1]';
      const witness2 = document.getElementById('stps_witness2')?.value || '[TESTIGO 2]';

      const companyName = profileData.companyName || '[RAZ√ìN SOCIAL]';
      const address = profileData.evaluationAddress || '[DIRECCI√ìN]';
      const phone = profileData.requestorPhone || '[TEL√âFONO]';
      const email = profileData.reportEmail || '[CORREO]';
      const legalRep = profileData.legalRep || '[REPRESENTANTE LEGAL]';

      const pdf = new jsPDF('p','mm','a4');

      const margin = 20;
      let y = margin;
      const lh = 5;
      const pageW = pdf.internal.pageSize.width;
      const maxW = pageW - margin*2;

      function addCentered(text, size=11, bold=false){
        pdf.setFont('helvetica', bold?'bold':'normal');
        pdf.setFontSize(size);
        const tw = pdf.getTextWidth(text);
        pdf.text(text, (pageW-tw)/2, y);
        y += lh;
      }
      function addText(text, size=10, bold=false, indent=0){
        pdf.setFont('helvetica', bold?'bold':'normal');
        pdf.setFontSize(size);
        const lines = pdf.splitTextToSize(text, maxW - indent);
        pdf.text(lines, margin+indent, y);
        y += lines.length*lh;
      }
      function space(n=1){ y += n*lh; }

      addCentered('SECRETAR√çA DEL TRABAJO Y PREVISI√ìN SOCIAL', 9, true);
      addCentered(document.getElementById('stps_officeLine2')?.value || 'OFICINA DE REPRESENTACI√ìN FEDERAL DEL TRABAJO EN EL ESTADO DE PUEBLA', 8, true);
      addCentered(document.getElementById('stps_officeLine3')?.value || 'DOMICILIO', 7, true);

      space(2);

      pdf.setFont('helvetica','bold'); pdf.setFontSize(9);
      const dateText = `Puebla, Puebla, a ${dateString}`;
      const dateW = pdf.getTextWidth(dateText);
      pdf.text(dateText, pageW - margin - dateW, y);
      y += lh*2;

      addText('Por este conducto y con fundamento en el Art√≠culo 19 de la Ley Federal de Procedimiento Administrativo, autorizo mediante el presente escrito a:', 9);
      space(0.5);
      addText(authorizedPersons, 9, true);
      space(0.5);

      addText('Para que conjunta o indistintamente puedan:', 9);
      addText('‚Ä¢ O√≠r y recibir notificaciones', 9, false, 5);
      addText('‚Ä¢ Realizar tr√°mites, gestiones y comparecencias necesarias', 9, false, 5);

      const procedureText = '‚Ä¢ Promover ante la Secretar√≠a del Trabajo y Previsi√≥n Social los procedimientos administrativos correspondientes, incluyendo ingreso o recepci√≥n de oficios de registro, inspecci√≥n, autorizaciones, continuidad de vigencias, aclaraciones, emplazamientos, recursos y cualquier asunto relativo a los recipientes sujetos a presi√≥n instalados en nuestra empresa';
      const procLines = pdf.splitTextToSize(procedureText, maxW - 5);
      pdf.text(procLines, margin+5, y);
      y += procLines.length*lh;

      space(0.5);
      addText('DATOS DEL CENTRO DE TRABAJO:', 9, true);
      addText(`Nombre/Raz√≥n Social: ${companyName}`, 9, false, 5);
      const addrLines = pdf.splitTextToSize(`Domicilio: ${address}`, maxW - 5);
      pdf.text(addrLines, margin+5, y); y += addrLines.length*lh;
      addText(`Tel√©fono: ${phone}`, 9, false, 5);
      addText(`Correo electr√≥nico: ${email}`, 9, false, 5);

      space(0.5);
      addText('DOCUMENTOS QUE SE ANEXAN:', 9, true);
      addText('‚Ä¢ Copia simple de identificaci√≥n oficial del Representante Legal', 9, false, 5);
      addText('‚Ä¢ Copia simple de identificaci√≥n oficial de la(s) persona(s) autorizada(s)', 9, false, 5);
      addText('‚Ä¢ Copia simple de identificaci√≥n oficial de los testigos', 9, false, 5);

      space(0.5);
      addText('Este documento se expide √∫nicamente para los fines se√±alados y dirigido exclusivamente a la dependencia mencionada.', 9);
      space(0.5);
      addText(`VIGENCIA: Del ${dateString} al 31 de diciembre de ${year}`, 9, true);
      space(0.5);
      addText('Agradeciendo la atenci√≥n prestada, quedo de ustedes.', 9);
      space(2);

      addCentered('ATENTAMENTE', 9, true);
      space(3);

      const sigW = 100;
      const sigX = (pageW - sigW)/2;
      pdf.line(sigX, y, sigX+sigW, y); y += lh;

      addCentered(legalRep, 9, true);
      addCentered('Representante Legal del Centro de Trabajo', 8);
      space(2);

      addCentered('TESTIGOS:', 9, true);
      space(1);

      const witnessY = y;
      const leftX = margin + 25;
      const rightX = pageW - margin - 75;
      pdf.line(leftX, witnessY, leftX+50, witnessY);
      pdf.line(rightX, witnessY, rightX+50, witnessY);

      pdf.setFont('helvetica','normal'); pdf.setFontSize(8);
      const w1 = witness1.length>25 ? witness1.slice(0,22)+'...' : witness1;
      const w2 = witness2.length>25 ? witness2.slice(0,22)+'...' : witness2;
      const w1W = pdf.getTextWidth(w1);
      const w2W = pdf.getTextWidth(w2);
      pdf.text(w1, leftX + (50-w1W)/2, witnessY+5);
      pdf.text(w2, rightX + (50-w2W)/2, witnessY+5);

      const safeName = companyName.replace(/[^a-zA-Z0-9]/g,'_');
      pdf.save(`Carta_Poder_STPS_${safeName}_${currentDate.toISOString().split('T')[0]}.pdf`);
      showStatus('documentsStatus','PDF descargado correctamente','success');
    } catch(err){
      console.error(err);
      showStatus('documentsStatus','Error al generar PDF','error');
    }
  }

  function generateServiceLetter(){ showStatus('documentsStatus','Funci√≥n en desarrollo','warning'); }
  function downloadServiceLetter(){ showStatus('documentsStatus','Funci√≥n en desarrollo','warning'); }
  function generateComplianceLetter(){ showStatus('documentsStatus','Funci√≥n en desarrollo','warning'); }
  function downloadComplianceLetter(){ showStatus('documentsStatus','Funci√≥n en desarrollo','warning'); }
  function generateMeetingAct(){ showStatus('documentsStatus','Funci√≥n en desarrollo','warning'); }
  function downloadMeetingAct(){ showStatus('documentsStatus','Funci√≥n en desarrollo','warning'); }

  // ================== INIT ==================
  document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('profileFile');
    const fileNameSpan = document.getElementById('fileSelectedName');

    if (fileInput && fileNameSpan) {
      fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          fileNameSpan.textContent = `Archivo: ${this.files[0].name}`;
          fileNameSpan.style.color = '#28a745';
          fileNameSpan.style.fontWeight = 'bold';
        } else {
          fileNameSpan.textContent = 'No se ha seleccionado ning√∫n archivo.';
          fileNameSpan.style.color = '#666';
          fileNameSpan.style.fontWeight = 'normal';
        }
      });
    }

    // Fecha actual en OT
    const issueDateInput = document.getElementById('wo_issueDate');
    if (issueDateInput) issueDateInput.value = new Date().toISOString().split('T')[0];

    // Autocomplete servicios en fila inicial
    document.querySelectorAll('.service-input').forEach(setupServiceAutocomplete);

    // Serie OT/OTB: info + sugerido
    document.querySelectorAll('input[name="orderSeries"]').forEach(r => r.addEventListener('change', updateOrderNumber));
    updateOrderNumber();

    // Listeners STPS
    document.querySelectorAll('.authCheck').forEach(ch => ch.addEventListener('change', composeAuthorizedList));
    const stpsOther = document.getElementById('stps_otherName');
    if (stpsOther) stpsOther.addEventListener('input', composeAuthorizedList);

    // Sincronizar al cambiar tab
    document.querySelectorAll('.nav-tab').forEach(tab => tab.addEventListener('click', syncData));

    generateQRCode();
    console.log('‚úÖ Sistema Ejecutiva Ambiental cargado (PDF OT inamovible + operativos ocultos en impresi√≥n)');
  });

  // ================== EXPORT GLOBAL ==================
  window.switchTab = switchTab;
  window.loadProfile = loadProfile;
  window.saveProfile = saveProfile;
  window.downloadProfileTemplate = downloadProfileTemplate;
  window.exportToExcelFormat = exportToExcelFormat;
  window.sendToClient = sendToClient;

  window.generateWorkOrder = generateWorkOrder;
  window.addWorkRow = addWorkRow;
  window.removeRow = removeRow;
  window.saveWorkOrder = saveWorkOrder;
  window.printWorkOrder = printWorkOrder;
  window.sendWorkOrder = sendWorkOrder;

  window.updateOrderNumber = updateOrderNumber;
  window.registerToSheets = registerToSheets;

  window.generateTextFromProfile = generateTextFromProfile;
  window.selectTextTemplate = selectTextTemplate;
  window.copyTextToClipboard = copyTextToClipboard;

  window.generateDocumentData = generateDocumentData;
  window.generateSTPS = generateSTPS;
  window.downloadSTPS = downloadSTPS;
  window.generateServiceLetter = generateServiceLetter;
  window.downloadServiceLetter = downloadServiceLetter;
  window.generateComplianceLetter = generateComplianceLetter;
  window.downloadComplianceLetter = downloadComplianceLetter;
  window.generateMeetingAct = generateMeetingAct;
  window.downloadMeetingAct = downloadMeetingAct;

  window.syncData = syncData;
</script>

</body>
</html>
