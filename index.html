<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema Ejecutiva Ambiental - Perfil de Datos & Orden de Trabajo</title>

  <!-- ========= ESTILOS ========= -->
  <style>
    *{box-sizing:border-box}

    body{
      font-family: Arial, sans-serif;
      margin:0; padding:20px;
      background:#f5f5f5; font-size:12px;
    }
    .main-container{max-width:1200px;margin:0 auto;}

    /* Tabs */
    .nav-tabs{display:flex;background:#fff;border-radius:8px 8px 0 0;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .nav-tab{flex:1;padding:15px 20px;background:#e9ecef;border:0;cursor:pointer;font-weight:bold;font-size:14px;transition:.3s;display:flex;align-items:center;justify-content:center;gap:8px}
    .nav-tab.active{background:#1e5a3e;color:#fff}
    .nav-tab:hover:not(.active){background:#dee2e6}
    .tab-content{display:none;background:#fff;border-radius:0 0 8px 8px;box-shadow:0 2px 10px rgba(0,0,0,.1);min-height:600px}
    .tab-content.active{display:block}

    /* Barras de acciones */
    .excel-controls{background:linear-gradient(135deg,#f8f9fa,#e9ecef);padding:15px;margin-bottom:0;border-left:4px solid #1e5a3e;display:flex;align-items:center;flex-wrap:wrap;gap:10px}
    .excel-controls button{background:#1e5a3e;color:#fff;border:0;padding:8px 15px;border-radius:4px;cursor:pointer;font-size:11px}
    .excel-controls button:hover{background:#2d7a4f}
    .file-input-label{background:#6c757d;color:#fff;padding:8px 15px;border-radius:4px;cursor:pointer;font-size:11px;display:inline-block}
    .file-input-label:hover{background:#5a6268}
    .file-input-label input{display:none}
    .status-message{margin-left:10px;padding:5px 10px;border-radius:4px;font-size:10px;font-weight:bold}
    .status-success{background:#d4edda;color:#155724}
    .status-error{background:#f8d7da;color:#721c24}
    .status-warning{background:#fff3cd;color:#856404}

    /* Encabezados */
    .header{background:linear-gradient(135deg,#1e5a3e,#2d7a4f);color:#fff;padding:15px;display:flex;justify-content:space-between;align-items:center}
    .logo-section{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#1e5a3e;font-weight:bold}
    .company-info h1{margin:0;font-size:16px;font-weight:bold}
    .company-info p{margin:2px 0;font-size:10px;opacity:.9}
    .document-info h2{margin:0;font-size:18px;font-weight:bold}

    .section{border-bottom:1px solid #ddd}
    .section-header{background:#1e5a3e;color:#fff;padding:8px 15px;font-weight:bold;font-size:11px;text-transform:uppercase;letter-spacing:.5px}
    .section-content{padding:15px}

    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px}
    .form-group{display:flex;flex-direction:column}
    .form-group.full-width{grid-column:1 / -1}
    label{font-weight:bold;color:#333;margin-bottom:3px;font-size:10px;text-transform:uppercase}
    input[type="text"],input[type="date"],input[type="tel"],input[type="email"],textarea,select{border:1px solid #ccc;padding:6px 8px;font-size:11px;border-radius:3px;background:#f9f9f9}
    input:focus,textarea:focus,select:focus{outline:0;border-color:#1e5a3e;background:#fff}
    textarea{resize:vertical;min-height:60px}

    /* Tabla OT */
    .work-table{width:100%;border-collapse:collapse;margin-top:10px;table-layout:fixed;background:#fff}
    .work-table th{background:#1e5a3e;color:#fff;font-weight:bold;text-align:center;padding:8px 4px;font-size:11px;border:1px solid #1e5a3e;white-space:normal;word-wrap:break-word}
    .work-table td{border:1px solid #ddd;padding:4px;text-align:left;font-size:10px;vertical-align:middle;background:#fff}
    .work-table input[type="text"],.work-table input[type="date"],.work-table select,.work-table textarea{border:1px solid transparent;width:100%;height:28px;padding:2px 4px;background:#f9f9f9;font-size:10px;margin:0;box-sizing:border-box}
    .work-table textarea{min-height:28px;resize:vertical;font-family:Arial, sans-serif}
    .work-table input:focus,.work-table textarea:focus,.work-table select:focus{background:#fff;border:1px solid #1e5a3e;outline:none}
    .add-row-btn{background:#28a745;color:#fff;border:0;padding:8px 15px;border-radius:3px;cursor:pointer;font-size:11px;margin-top:10px}
    .add-row-btn:hover{background:#218838}
    .remove-row-btn{background:#dc3545;color:#fff;border:0;padding:4px 8px;border-radius:3px;cursor:pointer;font-size:10px}
    .remove-row-btn:hover{background:#c82333}

    /* Indicador de sync */
    .data-sync-indicator{position:fixed;top:20px;right:20px;background:#1e5a3e;color:#fff;padding:8px 15px;border-radius:20px;font-size:11px;z-index:1000;opacity:0;transition:opacity .3s}
    .data-sync-indicator.show{opacity:1}

    .excel-mapping-info{background:#e3f2fd;border:1px solid #1976d2;border-radius:4px;padding:10px;margin:10px 0;font-size:10px}
    .excel-mapping-info strong{color:#1976d2}

    /* Impresi√≥n */
    @media print{
      .nav-tabs,.excel-controls,.excel-mapping-info{display:none}
      body{background:#fff;padding:0;font-size:11px}
      .main-container{margin:0;max-width:none;padding:0}
      @page{size:A4;margin:10mm}
    }

    /* Estilos para generadores de texto */
    .template-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:15px 0}
    .template-card{border:1px solid #e3e3e3;border-radius:8px;padding:15px;cursor:pointer;background:#fff;transition:.3s;position:relative}
    .template-card:hover{border-color:#1e5a3e;box-shadow:0 2px 8px rgba(30,90,62,.1)}
    .template-card.selected{border-color:#1e5a3e;box-shadow:0 0 0 2px #1e5a3e22}
    .template-card h4{margin:0 0 8px;color:#1e5a3e;font-size:14px}
    .template-card p{margin:0;color:#666;font-size:11px}
    .text-output{background:#f8f9fa;border:1px solid #ddd;border-radius:4px;padding:15px;min-height:200px;white-space:pre-wrap;font-family:monospace;font-size:11px;margin:10px 0}
    .copy-btn{background:#28a745;color:#fff;border:0;padding:8px 15px;border-radius:4px;cursor:pointer;font-size:11px;margin-top:10px}
    .copy-btn:hover{background:#218838}

    /* Documentos PDF */
    .document-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin:15px 0}
    .document-card{border:1px solid #e3e3e3;border-radius:8px;padding:15px;background:#fff}
    .document-card h4{margin:0 0 10px;color:#1e5a3e;font-size:14px}
    .document-card p{margin:0 0 10px;color:#666;font-size:11px}
    .document-actions{display:flex;gap:8px;flex-wrap:wrap}
    .pdf-btn{background:#dc3545;color:#fff;border:0;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:10px}
    .pdf-btn:hover{background:#c82333}

    @media print{
      #textTab,#documentsTab{display:none !important;}
    }
  </style>

</head>

<body>
<div class="main-container">

  <!-- Indicador -->
  <div id="syncIndicator" class="data-sync-indicator">‚úì Datos sincronizados</div>

  <!-- Tabs -->
  <div class="nav-tabs">
    <button class="nav-tab active" id="profileTabButton" onclick="switchTab('profile')">üë§ Perfil</button>
    <button class="nav-tab" id="workorderTabButton" onclick="switchTab('workorder')">üìã Orden de trabajo</button>
    <button class="nav-tab" id="textTabButton" onclick="switchTab('text')">üìù Textos</button>
    <button class="nav-tab" id="documentsTabButton" onclick="switchTab('documents')">üìÑ Documentos</button>
  </div>

  <!-- ================= TAB 1: PERFIL ================= -->
  <div id="profileTab" class="tab-content active">
    <div class="excel-controls">
      <strong>üìä Gesti√≥n de Perfil:</strong>
      <label class="file-input-label">üìÇ Examinar...
        <input type="file" id="profileFile" accept=".xlsx,.xls"/>
      </label>
      <span id="fileSelectedName" style="font-size:10px;color:#666;margin-right:10px;">No se ha seleccionado ning√∫n archivo.</span>
      <button onclick="loadProfile()">Cargar Perfil</button>
      <button onclick="saveProfile()">Guardar Perfil</button>
      <button onclick="downloadProfileTemplate()">Plantilla Perfil</button>
      <button onclick="exportToExcelFormat()">Exportar Formato Excel</button>
      <button onclick="sendToClient()">Enviar a Cliente</button>
      <span id="profileStatus"></span>
    </div>

    <div class="excel-mapping-info">
      <strong>üìä Mapeo Excel:</strong> Los datos se exportan con el formato est√°ndar de celdas. Para celdas combinadas, el sistema toma autom√°ticamente el valor de la celda izquierda superior.
    </div>

    <div class="header">
      <div class="logo-section">
        <div class="logo">EA</div>
        <div class="company-info">
          <h1>EJECUTIVA AMBIENTAL</h1>
          <p>SEGURIDAD E HIGIENE, CAPACITACI√ìN, MANTENIMIENTO INDUSTRIAL, PROTECCI√ìN CIVIL, MEDIO AMBIENTE</p>
        </div>
      </div>
      <div class="document-info">
        <h2>PERFIL DE DATOS DEL CLIENTE</h2>
        <p>Informaci√≥n General y Contacto</p>
      </div>
    </div>

    <!-- Info general -->
    <div class="section">
      <div class="section-header">Informaci√≥n General</div>
      <div class="section-content">
        <div class="form-grid">
          <div class="form-group"><label>Nombre y puesto solicitante</label><input type="text" id="requestorName" onchange="syncData()" data-excel="D3"></div>
          <div class="form-group"><label>Tel√©fono</label><input type="tel" id="requestorPhone" onchange="syncData()" data-excel="I7" placeholder="Tel√©fono de la empresa"></div>
          <div class="form-group full-width"><label>Denominaci√≥n/Raz√≥n Social</label><input type="text" id="companyName" onchange="syncData()" data-excel="D5"></div>
          <div class="form-group"><label>RFC</label><input type="text" id="rfc" onchange="syncData()" data-excel="D7"></div>
          <div class="form-group"><label>Sucursal</label><input type="text" id="branch" onchange="syncData()" placeholder="Ej: Sucursal Centro, Planta Norte"></div>
          <div class="form-group full-width"><label>Representante Legal</label><input type="text" id="legalRep" onchange="syncData()" data-excel="D9"></div>
          <div class="form-group full-width"><label>Direcci√≥n donde se evaluar√°</label><textarea id="evaluationAddress" onchange="syncData()" data-excel="D11"></textarea></div>
          <div class="form-group"><label>Responsable de atendernos</label><input type="text" id="contactPerson" onchange="syncData()" data-excel="D13"></div>
          <div class="form-group"><label>Tel√©fono</label><input type="tel" id="contactPhone" onchange="syncData()" data-excel="I13"></div>
          <div class="form-group full-width"><label>Giro</label><input type="text" id="businessType" onchange="syncData()" data-excel="D15"></div>
          <div class="form-group full-width"><label>Actividad Principal</label><textarea id="mainActivity" onchange="syncData()" data-excel="D17"></textarea></div>
          <div class="form-group"><label>Registro Patronal</label><input type="text" id="patronalRegistry" onchange="syncData()" data-excel="D19"></div>
          <div class="form-group"><label>Capacidad de Operaci√≥n</label><input type="text" id="operationCapacity" onchange="syncData()" data-excel="D21"></div>
          <div class="form-group"><label>Capacidad Instalada</label><input type="text" id="installedCapacity" onchange="syncData()" data-excel="I21"></div>
          <div class="form-group full-width"><label>D√≠as, turnos y horarios de trabajo</label><textarea id="workSchedule" onchange="syncData()" data-excel="D23"></textarea></div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Sobre el Informe de Resultados</div>
      <div class="section-content">
        <div class="form-grid">
          <div class="form-group"><label>Nombre de a quien se dirige</label><input type="text" id="reportRecipientName" onchange="syncData()" data-excel="D26"></div>
          <div class="form-group"><label>Puesto de a quien se dirige</label><input type="text" id="reportRecipientPosition" onchange="syncData()" data-excel="D28"></div>
          <div class="form-group full-width"><label>Correo a enviar el informe digital</label><input type="email" id="reportEmail" onchange="syncData()" data-excel="D30"></div>
        </div>
        <div class="form-group full-width">
          <label>Breve descripci√≥n del proceso operativo o productivo</label>
          <textarea id="processDescription" onchange="syncData()" style="min-height:100px;"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= TAB 2: ORDEN DE TRABAJO ================= -->
  <div id="workorderTab" class="tab-content">
    <div class="excel-controls">
      <strong>üîß Gesti√≥n de Orden:</strong>
      <button onclick="generateWorkOrder()">Generar desde Perfil</button>
      <button onclick="saveWorkOrder()">Guardar Orden</button>
      <button onclick="printWorkOrder()">Imprimir/PDF</button>
      <button onclick="sendAndRegisterWorkOrder()">üì§ Enviar y Registrar OT</button>
      <button onclick="sendWorkOrder()">Enviar por Email</button>
      <span id="workorderStatus"></span>
    </div>

    <div class="header">
      <div class="logo-section">
        <div class="logo">EA</div>
        <div class="company-info">
          <h1>EJECUTIVA AMBIENTAL</h1>
          <p>SEGURIDAD E HIGIENE, CAPACITACI√ìN MANTENIMIENTO INDUSTRIAL, PROTECCI√ìN CIVIL, MEDIO AMBIENTE</p>
        </div>
      </div>
      <div class="document-info">
        <h2>ORDEN DE TRABAJO</h2>
        <p id="workOrderPageInfo">P√°gina 1 de 1</p>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Informaci√≥n del Servicio</div>
      <div class="section-content">
        <div class="form-grid">
          <div class="form-group"><label>N¬∞ de Orden de Servicio</label><input type="text" id="wo_orderNumber" placeholder="OT25-0123-XX"></div>
          <div class="form-group"><label>Fecha de Emisi√≥n</label><input type="date" id="wo_issueDate"></div>
          <div class="form-group"><label>Referencia de Cotizaci√≥n</label><input type="text" id="wo_quoteRef"></div>
          <div class="form-group"><label><!-- vacio --></label><div></div></div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Informaci√≥n del Cliente (Auto-generada desde Perfil)</div>
      <div class="section-content">
        <div class="form-grid">
          <div class="form-group"><label>Nombre o Raz√≥n Social</label><input type="text" id="wo_clientName" readonly style="background:#e9ecef"></div>
          <div class="form-group"><label>Sucursal</label><input type="text" id="wo_branch" readonly style="background:#e9ecef"></div>
          <div class="form-group full-width"><label>Direcci√≥n del Servicio</label><input type="text" id="wo_serviceAddress" readonly style="background:#e9ecef"></div>
          <div class="form-group"><label>Responsable de atendernos</label><input type="text" id="wo_contactName" readonly style="background:#e9ecef"></div>
          <div class="form-group"><label>Tel√©fono</label><input type="tel" id="wo_phone" readonly style="background:#e9ecef"></div>
          <div class="form-group"><label>Email</label><input type="email" id="wo_email" placeholder="Editable - completar manualmente"></div>
        </div>
        <div class="form-group">
          <label>Destinatario del Informe</label>
          <div class="form-grid">
            <div class="form-group"><label>Nombre</label><input type="text" id="wo_reportTo" readonly style="background:#e9ecef"></div>
            <div class="form-group"><label>Puesto</label><input type="text" id="wo_reportPosition" readonly style="background:#e9ecef"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Desarrollo del Trabajo</div>
      <div class="section-content">
        <table class="work-table" id="workTable">
          <thead>
          <tr>
            <th style="width:15%">SERVICIO</th>
            <th style="width:15%">PERSONAL ASIGNADO</th>
            <th style="width:15%">FECHA</th>
            <th style="width:15%">CANTIDAD</th>
            <th style="width:38%">OBSERVACIONES</th>
            <th style="width:2%"></th>
          </tr>
          </thead>
          <tbody id="workTableBody">
          <tr>
            <td><input type="text" placeholder="NOM-XXX-STPS"></td>
            <td>
              <select>
                <option value="">Seleccionar...</option>
                <option>Mart√≠n Luna</option>
                <option>Jimmy Ayala</option>
                <option>Iv√°n Z√°rate</option>
                <option>Eduardo Campos</option>
                <option>Adri√°n H</option>
                <option>Externo</option>
              </select>
            </td>
            <td><input type="date"></td>
            <td><input type="text" placeholder="5 dosis, 10 RSP, etc..."></td>
            <td><textarea rows="2"></textarea></td>
            <td style="text-align:center;"><button class="remove-row-btn" onclick="removeRow(this)">‚úñ</button></td>
          </tr>
          </tbody>
        </table>
        <button class="add-row-btn" onclick="addWorkRow()">+ Agregar Fila</button>

        <div class="form-group full-width" style="margin-top:15px;">
          <label>Observaciones Generales</label>
          <textarea id="wo_generalObservations" style="min-height:80px;" placeholder="üìã RECORDATORIO: Portar EPP..."></textarea>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Autorizaci√≥n y Firmas</div>
      <div class="section-content">
        <div class="form-grid">
          <div class="form-group"><label>Realiz√≥</label><input type="text" id="wo_preparedBy" placeholder="Nombre de quien elabor√≥"></div>
          <div class="form-group"><label>Autoriz√≥</label><input type="text" id="wo_authorizedBy" value="ING. EDUWIN IV√ÅN HERN√ÅNDEZ Z√ÅRATE - DIRECTOR" readonly style="background:#e9ecef"></div>
        </div>
        <div class="form-group full-width" style="margin-top:20px;padding:15px;border:1px solid #ddd;border-radius:4px;background:#f8f9fa;">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;">
            <div style="flex:2;margin-right:20px;">
              <label style="font-weight:bold;color:#1e5a3e;">Firma del Cliente</label>
              <p style="margin:10px 0;font-style:italic;font-size:11px;">"He recibido visita del proveedor para la realizaci√≥n de los servicios se√±alados en la presente orden."</p>
              <div style="margin-top:30px;border-bottom:1px solid #333;width:70%;display:inline-block;"></div>
              <p style="margin:5px 0;font-size:10px;">Firma y Nombre del Cliente</p>
            </div>
            <div style="flex:1;text-align:center;">
              <div id="qrCodeContainer" style="text-align:center;padding:10px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= TAB 3: GENERADOR DE TEXTOS ================= -->
  <div id="textTab" class="tab-content">
    <div class="excel-controls">
      <strong>üìù Generador de Textos:</strong>
      <button onclick="generateTextFromProfile()">Auto-completar desde Perfil</button>
      <button onclick="copyTextToClipboard()">Copiar Texto</button>
      <span id="textStatus"></span>
    </div>

    <div class="section">
      <div class="section-header">Seleccionar Tipo de Texto</div>
      <div class="section-content">
        <div class="template-grid">
          <div class="template-card" onclick="selectTextTemplate('email_profile', this)">
            <h4>üìß Email - Solicitud de Perfil</h4>
            <p>Para solicitar datos del cliente</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('email_workorder', this)">
            <h4>üìß Email - Orden de Trabajo</h4>
            <p>Env√≠o de orden con detalles</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('email_followup', this)">
            <h4>üìß Email - Seguimiento</h4>
            <p>Recordatorio y coordinaci√≥n</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('email_quote', this)">
            <h4>üìß Email - Cotizaci√≥n</h4>
            <p>Env√≠o de presupuesto</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('email_results', this)">
            <h4>üìß Email - Resultados</h4>
            <p>Entrega de informe final</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('receipt', this)">
            <h4>üí∞ Recibo de Pago</h4>
            <p>Comprobante de pago membretado</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('status_letter', this)">
            <h4>üìÑ Carta Estatus</h4>
            <p>Estado del servicio o proyecto</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('memo', this)">
            <h4>üìù Memor√°ndum</h4>
            <p>Comunicaci√≥n interna</p>
          </div>
          <div class="template-card" onclick="selectTextTemplate('invoice', this)">
            <h4>üìã Datos bancarios </h4>
            <p>Documento de facturaci√≥n</p>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Texto Generado</div>
      <div class="section-content">
        <div class="text-output" id="textOutput">Selecciona un tipo de texto para generar el contenido...</div>
        <button class="copy-btn" onclick="copyTextToClipboard()">üìã Copiar al Portapapeles</button>
      </div>
    </div>
  </div>

  <!-- ================= TAB 4: DOCUMENTOS PDF ================= -->
  <div id="documentsTab" class="tab-content">
    <div class="excel-controls">
      <strong>üìÑ Generador de Documentos:</strong>
      <button onclick="generateDocumentData()">Auto-completar desde Perfil</button>
      <span id="documentsStatus"></span>
    </div>

    <div class="section">
      <div class="section-header">Documentos Disponibles</div>
      <div class="section-content">
        <div class="document-grid">
          <div class="document-card">
            <h4>üèõÔ∏è Carta Poder STPS</h4>
            <p>Documento oficial para la Secretar√≠a del Trabajo y Previsi√≥n Social</p>
            <div class="document-actions">
              <button class="pdf-btn" onclick="generateSTPS()">Auto-completar</button>
              <button class="pdf-btn" onclick="downloadSTPS()">Descargar PDF</button>
            </div>
          </div>
          
          <div class="document-card">
            <h4>üìã Carta de Servicios</h4>
            <p>Documento que certifica los servicios realizados</p>
            <div class="document-actions">
              <button class="pdf-btn" onclick="generateServiceLetter()">Generar</button>
              <button class="pdf-btn" onclick="downloadServiceLetter()">Descargar PDF</button>
            </div>
          </div>

          <div class="document-card">
            <h4>üìÑ Constancia de Cumplimiento</h4>
            <p>Certificado de cumplimiento normativo</p>
            <div class="document-actions">
              <button class="pdf-btn" onclick="generateComplianceLetter()">Generar</button>
              <button class="pdf-btn" onclick="downloadComplianceLetter()">Descargar PDF</button>
            </div>
          </div>

          <div class="document-card">
            <h4>üìù Acta de Reuni√≥n</h4>
            <p>Documento de minuta de reuni√≥n t√©cnica</p>
            <div class="document-actions">
              <button class="pdf-btn" onclick="generateMeetingAct()">Generar</button>
              <button class="pdf-btn" onclick="downloadMeetingAct()">Descargar PDF</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Carta Poder STPS (mantener la funcionalidad existente) -->
    <div class="section" id="stpsSection">
      <div class="section-header">Configuraci√≥n - Carta Poder STPS</div>
      <div class="section-content">
        <div class="form-grid">
          <div class="form-group full-width">
            <label>L√≠nea 2 (Dependencia)</label>
            <input type="text" id="stps_officeLine2" value="OFICINA DE REPRESENTACI√ìN FEDERAL DEL TRABAJO EN EL ESTADO DE PUEBLA CON SEDE EN PUEBLA">
          </div>
          <div class="form-group full-width">
            <label>L√≠nea 3 (Domicilio)</label>
            <input type="text" id="stps_officeLine3" value="EDIFICIO SELAFE, AV. 31 PONIENTE NO. 2904, P.B., COL. EL VERGEL, C.P. 72400, PUEBLA, PUEBLA">
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group full-width">
            <label>Selecciona una o varias personas autorizadas</label>
            <div>
              <label><input type="checkbox" class="authCheck" value="Gonzalo Eli Torres Quiroz"> Gonzalo Eli Torres Quiroz</label><br/>
              <label><input type="checkbox" class="authCheck" value="Eduwin Iv√°n Hern√°ndez Z√°rate"> Eduwin Iv√°n Hern√°ndez Z√°rate</label><br/>
              <label><input type="checkbox" class="authCheck" value="Jimmy Jeynson Ayala Borrallez"> Jimmy Jeynson Ayala Borrallez</label><br/>
              <label><input type="checkbox" class="authCheck" value="Mart√≠n Luna C√≥rdova"> Mart√≠n Luna C√≥rdova</label>
            </div>
            <div style="margin-top:8px;">
              <label>Otro (editable):</label>
              <input type="text" id="stps_otherName" placeholder="Escribe otro nombre completo">
            </div>
            
            <div class="form-group full-width">
              <label>Lista final (puedes editar manualmente)</label>
              <textarea id="stps_authorizedPersons" style="min-height:70px;" placeholder="Nombres completos separados por comas"></textarea>
            </div>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group"><label>Testigo 1</label><input type="text" id="stps_witness1" placeholder="Nombre completo del testigo 1"></div>
          <div class="form-group"><label>Testigo 2</label><input type="text" id="stps_witness2" placeholder="Nombre completo del testigo 2"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ========= LIBRER√çAS ========= -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- ========= SCRIPT PRINCIPAL ========= -->
<script>
  // Variables globales
  let profileData = {};
  let workOrderData = {};
  let selectedTextTemplate = null;

  const excelCellMapping = {
    'requestorName':'D3','companyName':'D5','rfc':'D7','requestorPhone':'I7','legalRep':'D9',
    'evaluationAddress':'D11','contactPerson':'D13','contactPhone':'I13','businessType':'D15',
    'mainActivity':'D17','patronalRegistry':'D19','operationCapacity':'D21','installedCapacity':'I21',
    'workSchedule':'D23','reportRecipientName':'D26','reportEmail':'D30','reportRecipientPosition':'D28'
  };

  // Funciones de utilidad
  function getCellValue(ws, cellRef) {
    try {
      const c = ws[cellRef];
      return (c && c.v !== undefined) ? c.v : '';
    } catch(e) {
      return '';
    }
  }

  function setCellValue(ws, cellRef, value) {
    try {
      if (value !== undefined && value !== null && value !== '') {
        ws[cellRef] = {v: value, t: 's'};
      }
    } catch(e) {
      console.error('Error setting cell value:', e);
    }
  }

  function showStatus(elementId, message, type = 'success') {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    element.innerHTML = `<span class="status-message status-${type}">${message}</span>`;
    setTimeout(() => {
      element.innerHTML = '';
    }, 3000);
  }

  function showSyncIndicator() {
    const el = document.getElementById('syncIndicator');
    if (el) {
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2000);
    }
  }

  function copyToClipboard(text) {
    if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(() => {
        console.log('Texto copiado al portapapeles');
      }).catch(err => {
        console.error('Error al copiar:', err);
      });
    } else {
      // Fallback para navegadores m√°s antiguos
      const textArea = document.createElement('textarea');
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
    }
  }

  // Funci√≥n para cambiar pesta√±as
  function switchTab(name) {
    try { 
      window.scrollTo({top: 0, behavior: 'smooth'}); 
    } catch(e) { 
      window.scrollTo(0, 0); 
    }
    
    // Remover clases activas
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    
    // Activar pesta√±a correspondiente
    const tabMap = {
      'profile': { content: 'profileTab', button: 'profileTabButton' },
      'workorder': { content: 'workorderTab', button: 'workorderTabButton' },
      'text': { content: 'textTab', button: 'textTabButton' },
      'documents': { content: 'documentsTab', button: 'documentsTabButton' }
    };
    
    if (tabMap[name]) {
      const contentEl = document.getElementById(tabMap[name].content);
      const buttonEl = document.getElementById(tabMap[name].button);
      
      if (contentEl) contentEl.classList.add('active');
      if (buttonEl) buttonEl.classList.add('active');
    }
  }

  // Funci√≥n principal de sincronizaci√≥n
  function syncData() {
    const fields = [
      'requestorName','requestorPhone','companyName','rfc','branch','legalRep',
      'evaluationAddress','contactPerson','contactPhone','businessType','mainActivity',
      'patronalRegistry','operationCapacity','installedCapacity','workSchedule',
      'reportRecipientName','reportRecipientPosition','reportEmail','processDescription'
    ];
    
    fields.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        profileData[id] = (el.type === 'checkbox') ? el.checked : el.value;
      }
    });
    
    updateWorkOrderFromProfile();
    showSyncIndicator();
  }

  function updateWorkOrderFromProfile() {
    const map = {
      'companyName': 'wo_clientName',
      'branch': 'wo_branch',
      'evaluationAddress': 'wo_serviceAddress',
      'contactPerson': 'wo_contactName',
      'contactPhone': 'wo_phone',
      'reportRecipientName': 'wo_reportTo',
      'reportRecipientPosition': 'wo_reportPosition'
    };
    
    Object.keys(map).forEach(k => {
      const v = profileData[k] || '';
      const f = document.getElementById(map[k]);
      if (f) {
        f.value = v;
      }
    });
  }

  // Funciones de perfil
  function loadProfile() {
    const input = document.getElementById('profileFile');
    const file = input?.files[0];
    
    if (!file) {
      showStatus('profileStatus', 'Selecciona un archivo Excel', 'warning');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type: 'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        populateProfileFromExcel(ws);
        showStatus('profileStatus', 'Perfil cargado exitosamente', 'success');
      } catch(err) {
        console.error(err);
        showStatus('profileStatus', 'Error al leer archivo Excel', 'error');
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function populateProfileFromExcel(ws) {
    Object.keys(excelCellMapping).forEach(id => {
      const ref = excelCellMapping[id];
      const val = getCellValue(ws, ref);
      const el = document.getElementById(id);
      
      if (el && val) {
        if (el.type === 'checkbox') {
          el.checked = ['SI', 'YES', 'TRUE', '1', true].includes(String(val).toUpperCase());
        } else {
          el.value = String(val);
        }
      }
    });
    syncData();
  }

  function saveProfile() {
    try {
      const wb = XLSX.utils.book_new();
      const wsData = {};
      
      Object.keys(excelCellMapping).forEach(id => {
        const el = document.getElementById(id);
        const ref = excelCellMapping[id];
        if (el && el.value) {
          setCellValue(wsData, ref, el.value);
        }
      });
      
      const ws = XLSX.utils.json_to_sheet([]);
      Object.keys(wsData).forEach(r => ws[r] = wsData[r]);
      XLSX.utils.book_append_sheet(wb, ws, "Perfil_Cliente");
      
      const name = profileData.companyName || 'Cliente';
      const fileName = `Perfil_${name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      showStatus('profileStatus', 'Perfil guardado correctamente', 'success');
    } catch(err) {
      console.error(err);
      showStatus('profileStatus', 'Error al guardar perfil', 'error');
    }
  }

  function downloadProfileTemplate() {
    try {
      const wb = XLSX.utils.book_new();
      const data = {};
      
      const examples = {
        'D3': 'Juan P√©rez - Gerente',
        'D5': 'Empresa Ejemplo S.A. de C.V.',
        'D7': 'EEJ123456ABC',
        'I7': '222-123-4567',
        'D9': 'Mar√≠a Gonz√°lez',
        'D11': 'Av. Principal 123, Puebla, Pue.',
        'D13': 'Ana Mart√≠nez',
        'I13': '222-987-6543',
        'D15': 'Manufactura Industrial',
        'D17': 'Fabricaci√≥n de met√°licos',
        'D19': 'RP-12345-2023',
        'D21': '1000 u/d√≠a',
        'I21': '1500 u/d√≠a',
        'D23': 'L-V 7:00-15:00',
        'D26': 'informes@empresa.com',
        'D28': 'Director T√©cnico',
        'D30': 'gerencia@empresa.com'
      };
      
      Object.keys(examples).forEach(r => setCellValue(data, r, examples[r]));
      
      const ws = XLSX.utils.json_to_sheet([]);
      Object.keys(data).forEach(r => ws[r] = data[r]);
      XLSX.utils.book_append_sheet(wb, ws, "Plantilla");
      
      XLSX.writeFile(wb, "Plantilla_Perfil_Cliente_EA.xlsx");
      showStatus('profileStatus', 'Plantilla descargada correctamente', 'success');
    } catch(err) {
      console.error(err);
      showStatus('profileStatus', 'Error al generar plantilla', 'error');
    }
  }

  function exportToExcelFormat() {
    saveProfile();
  }

  function sendToClient() {
    const email = document.getElementById('reportEmail')?.value;
    const company = document.getElementById('companyName')?.value || 'Su Empresa';
    
    if (!email) {
      showStatus('profileStatus', 'Ingresa un email de contacto primero', 'warning');
      return;
    }
    
    const subject = `Perfil de Datos - ${company} - Ejecutiva Ambiental`;
    const body = `Estimado cliente,

Adjunto encontrar√° la plantilla del Perfil de Datos para completar con la informaci√≥n de su empresa.

Saludos cordiales,
Ejecutiva Ambiental`;

    window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    showStatus('profileStatus', 'Cliente de email abierto', 'success');
  }

  // Funciones de orden de trabajo
  function generateWorkOrder() {
    const today = new Date();
    const dateInput = document.getElementById('wo_issueDate');
    if (dateInput) {
      dateInput.value = today.toISOString().split('T')[0];
    }
    
    const orderInput = document.getElementById('wo_orderNumber');
    if (orderInput) {
      const orderNum = `OT${String(today.getFullYear() % 100).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}-`;
      orderInput.value = orderNum;
    }
    
    syncData();
    generateQRCode();
    showStatus('workorderStatus', 'Orden de trabajo generada autom√°ticamente', 'success');
  }

  function generateQRCode() {
    const cont = document.getElementById('qrCodeContainer');
    if (!cont) return;
    
    cont.innerHTML = '';
    
    const img = document.createElement('img');
    img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=tel:2229417295';
    img.alt = 'Llamar al 2229417295';
    img.style.cssText = 'width:80px;height:80px;border:1px solid #ccc;border-radius:4px;';
    cont.appendChild(img);
    
    const txt = document.createElement('div');
    txt.textContent = 'Dudas: 2229417295';
    txt.style.cssText = 'font-size:8px;text-align:center;margin-top:2px;';
    cont.appendChild(txt);
  }

  function addWorkRow() {
    const tbody = document.getElementById('workTableBody');
    if (!tbody) return;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" placeholder="NOM-XXX-STPS"></td>
      <td>
        <select>
          <option value="">Seleccionar...</option>
          <option>Mart√≠n Luna</option>
          <option>Jimmy Ayala</option>
          <option>Iv√°n Z√°rate</option>
          <option>Gonzalo Torres</option>
          <option>Eduardo Campos</option>
          <option>Adri√°n H</option>
          <option>Externo</option>
        </select>
      </td>
      <td><input type="date"></td>
      <td><input type="text" placeholder="Ruido, Vibraci√≥n, etc."></td>
      <td><textarea rows="2"></textarea></td>
      <td style="text-align:center;"><button class="remove-row-btn" onclick="removeRow(this)">‚úñ</button></td>`;
    tbody.appendChild(tr);
  }

  function removeRow(btn) {
    if (btn && btn.closest) {
      btn.closest('tr').remove();
    }
  }

  function saveWorkOrder() {
    try {
      const orderNumber = document.getElementById('wo_orderNumber')?.value || 'Nueva';
      const issueDate = document.getElementById('wo_issueDate')?.value || '';
      const quoteRef = document.getElementById('wo_quoteRef')?.value || '';
      
      const data = {
        'Numero_Orden': orderNumber,
        'Fecha_Emision': issueDate,
        'Referencia_Cotizacion': quoteRef,
        'Cliente': document.getElementById('wo_clientName')?.value || '',
        'Sucursal': document.getElementById('wo_branch')?.value || '',
        'Direccion_Servicio': document.getElementById('wo_serviceAddress')?.value || '',
        'Responsable_Atencion': document.getElementById('wo_contactName')?.value || '',
        'Telefono': document.getElementById('wo_phone')?.value || '',
        'Email': document.getElementById('wo_email')?.value || '',
        'Destinatario_Informe': document.getElementById('wo_reportTo')?.value || '',
        'Puesto_Destinatario': document.getElementById('wo_reportPosition')?.value || '',
        'Observaciones_Generales': document.getElementById('wo_generalObservations')?.value || '',
        'Realizo': document.getElementById('wo_preparedBy')?.value || '',
        'Autorizo': document.getElementById('wo_authorizedBy')?.value || ''
      };
      
      const items = [];
      const workRows = document.querySelectorAll('#workTableBody tr');
      workRows.forEach((row, i) => {
        const fields = row.querySelectorAll('input, select, textarea');
        if (fields.length >= 5 && fields[0].value) {
          items.push({
            'Item': i + 1,
            'Norma': fields[0].value,
            'Personal_Asignado': fields[1].value,
            'Fecha': fields[2].value,
            'Tipo_Mediciones': fields[3].value,
            'Observaciones': fields[4].value
          });
        }
      });
      
      const wb = XLSX.utils.book_new();
      const wsG = XLSX.utils.json_to_sheet([data]);
      XLSX.utils.book_append_sheet(wb, wsG, "Datos_Generales");
      
      if (items.length) {
        const wsW = XLSX.utils.json_to_sheet(items);
        XLSX.utils.book_append_sheet(wb, wsW, "Detalle_Trabajo");
      }
      
      const fileName = `Orden_Trabajo_${orderNumber}_${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, fileName);
      showStatus('workorderStatus', 'Orden de trabajo guardada', 'success');
    } catch(err) {
      console.error(err);
      showStatus('workorderStatus', 'Error al guardar orden', 'error');
    }
  }

  function printWorkOrder() {
    const orderNumber = document.getElementById('wo_orderNumber')?.value || 'OT';
    const client = document.getElementById('wo_clientName')?.value || 'Cliente';
    document.title = `${orderNumber} - ${client}`;
    
    const controls = document.querySelectorAll('.excel-controls, .nav-tabs, .excel-mapping-info');
    controls.forEach(e => e.style.display = 'none');
    
    // Ocultar otras pesta√±as
    document.getElementById('profileTab').style.display = 'none';
    document.getElementById('textTab').style.display = 'none';
    document.getElementById('documentsTab').style.display = 'none';
    document.getElementById('workorderTab').style.display = 'block';
    
    window.print();
    
    setTimeout(() => {
      controls.forEach(e => e.style.display = '');
      document.getElementById('profileTab').style.display = '';
      document.getElementById('textTab').style.display = '';
      document.getElementById('documentsTab').style.display = '';
      switchTab('workorder');
      document.title = 'SEA - Perfil de Datos & Orden de Trabajo';
    }, 1000);
  }

  function sendWorkOrder() {
    const email = document.getElementById('wo_email')?.value;
    const orderNumber = document.getElementById('wo_orderNumber')?.value || 'Nueva';
    
    if (!email) {
      showStatus('workorderStatus', 'No hay email de cliente disponible', 'warning');
      return;
    }
    
    const cc = 'eduwin.ejecutiva@gmail.com';
    const branch = profileData.branch || 'No especificada';
    const installed = profileData.installedCapacity || 'No especificada';
    const operation = profileData.operationCapacity || 'No especificada';
    const patronal = profileData.patronalRegistry || 'No especificado';
    const giro = profileData.businessType || 'No especificado';
    const company = profileData.companyName || 'Cliente';
    const address = profileData.evaluationAddress || '';
    const maps = address ? `https://maps.google.com/maps?q=${encodeURIComponent(address.trim())}` : 'Direcci√≥n no disponible';
    
    const subject = `Orden de Trabajo ${orderNumber} - ${company} - Ejecutiva Ambiental`;
    const body = `Estimado,

Adjunto encontrar√° la Orden de Trabajo ${orderNumber} para los servicios programados.

üè¢ Raz√≥n Social: ${company}
‚Ä¢ Sucursal: ${branch}
‚Ä¢ Giro/Actividad: ${giro}
‚Ä¢ Registro Patronal: ${patronal}

‚öôÔ∏è Capacidad Instalada: ${installed}
‚öô Capacidad de Operaci√≥n: ${operation}

üìç Direcci√≥n: ${address}
üîó Google Maps: ${maps}

Saludos cordiales,
Ejecutiva Ambiental
Tel: 222-941-7295`;

    window.location.href = `mailto:${email}?cc=${cc}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    showStatus('workorderStatus', `Email preparado con copia a ${cc}`, 'success');
  }

  // Funciones de generador de textos
  function generateTextFromProfile() {
    if (selectedTextTemplate) {
      selectTextTemplate(selectedTextTemplate);
    } else {
      selectTextTemplate('email_profile', document.querySelector('.template-card'));
    }
    showStatus('textStatus', 'Texto auto-completado desde el perfil', 'success');
  }

  function selectTextTemplate(type, el) {
    selectedTextTemplate = type;
    document.querySelectorAll('.template-card').forEach(n => n.classList.remove('selected'));
    if (el) el.classList.add('selected');
    
    const company = profileData.companyName || 'Cliente';
    const order = document.getElementById('wo_orderNumber')?.value || 'Nueva';
    const branch = profileData.branch || 'No especificada';
    const address = profileData.evaluationAddress || '';
    const maps = address ? `https://maps.google.com/maps?q=${encodeURIComponent(address.trim())}` : 'Direcci√≥n no disponible';
    const contact = profileData.contactPerson || '';
    const phone = profileData.contactPhone || '';
    const email = profileData.reportEmail || '';
    const currentDate = new Date().toLocaleDateString('es-MX');
    
    let text = '';

    switch (type) {
      case 'email_profile':
        text = `Para: ${email}
CC: eduwin.ejecutiva@gmail.com
Asunto: Solicitud de Perfil de Datos - ${company} - Ejecutiva Ambiental

Estimado cliente,

Esperamos que se encuentre bien.

Para brindarle el mejor servicio, necesitamos completar su perfil de datos empresariales.

Por favor, complete la siguiente informaci√≥n:

üìã DATOS REQUERIDOS:
‚Ä¢ Nombre y puesto del solicitante
‚Ä¢ Denominaci√≥n/Raz√≥n Social completa
‚Ä¢ RFC de la empresa
‚Ä¢ Direcci√≥n donde se realizar√° la evaluaci√≥n
‚Ä¢ Contacto responsable y tel√©fono
‚Ä¢ Giro comercial y actividad principal
‚Ä¢ Registro patronal
‚Ä¢ Horarios y turnos de trabajo

üìß RESPUESTA:
Favor de enviar la informaci√≥n completa a este correo.

Si tiene alguna duda, no dude en contactarnos al 222-941-7295.

Quedamos atentos a su respuesta.

Saludos cordiales,
EJECUTIVA AMBIENTAL
Tel: 222-941-7295
Email: eduwin.ejecutiva@gmail.com`;
        break;

      case 'email_workorder':
        text = `Para: ${email}
CC: eduwin.ejecutiva@gmail.com
Asunto: Orden de Trabajo ${order} - ${company} - Ejecutiva Ambiental

Estimado cliente,

Adjunto encontrar√° la Orden de Trabajo ${order} para los servicios programados.

üè¢ DETALLES DEL SERVICIO:
‚Ä¢ Empresa: ${company}
‚Ä¢ Sucursal: ${branch}
‚Ä¢ Orden: ${order}
‚Ä¢ Fecha de emisi√≥n: ${currentDate}

üìç DIRECCI√ìN DEL SERVICIO:
${address}
üó∫Ô∏è Google Maps: ${maps}

üìû COORDINACI√ìN:
Para coordinar fechas y horarios de visita, favor de contactarnos:
‚Ä¢ Tel: 222-941-7295
‚Ä¢ Email: eduwin.ejecutiva@gmail.com

üìã DOCUMENTACI√ìN:
Revise los servicios detallados en la orden adjunta y confirme:
‚Ä¢ Fechas disponibles para la visita
‚Ä¢ Horarios de acceso preferidos
‚Ä¢ Contacto responsable el d√≠a del servicio

Quedamos pendientes de su confirmaci√≥n.

Saludos cordiales,
EJECUTIVA AMBIENTAL
Seguridad e Higiene | Capacitaci√≥n | Mantenimiento Industrial`;
        break;

      case 'email_followup':
        text = `Para: ${email}
CC: eduwin.ejecutiva@gmail.com
Asunto: Seguimiento de Servicio - ${company} - Ejecutiva Ambiental

Estimado cliente,

Esperamos que est√© bien.

Damos seguimiento a los servicios programados para su empresa.

üìã RECORDATORIO:
‚Ä¢ Servicios pendientes de coordinar
‚Ä¢ Documentaci√≥n en proceso
‚Ä¢ Pr√≥xima visita programada

üìû CONTACTO:
Para cualquier duda o reprogramaci√≥n:
Tel: 222-941-7295
Email: eduwin.ejecutiva@gmail.com

Quedamos atentos.

Saludos cordiales,
EJECUTIVA AMBIENTAL`;
        break;

      case 'email_quote':
        text = `Para: ${email}
CC: eduwin.ejecutiva@gmail.com
Asunto: Cotizaci√≥n de Servicios - ${company} - Ejecutiva Ambiental

Estimado cliente,

Adjunto encontrar√° la cotizaci√≥n solicitada para los servicios de seguridad e higiene.

üí∞ PROPUESTA ECON√ìMICA:
‚Ä¢ Empresa: ${company}
‚Ä¢ Sucursal: ${branch}
‚Ä¢ Fecha: ${currentDate}

üìã SERVICIOS INCLUIDOS:
‚Ä¢ Evaluaciones de seguridad e higiene
‚Ä¢ Documentaci√≥n t√©cnica completa
‚Ä¢ Certificados oficiales
‚Ä¢ Seguimiento y asesor√≠a

‚è∞ VIGENCIA:
Esta cotizaci√≥n tiene vigencia de 30 d√≠as naturales.

üìû PARA CONTRATAR:
Tel: 222-941-7295
Email: eduwin.ejecutiva@gmail.com

Quedamos a sus √≥rdenes para cualquier aclaraci√≥n.

Saludos cordiales,
EJECUTIVA AMBIENTAL`;
        break;

      case 'email_results':
        text = `Para: ${email}
CC: eduwin.ejecutiva@gmail.com
Asunto: Entrega de Resultados - ${company} - Ejecutiva Ambiental

Estimado cliente,

Nos complace entregar los resultados de las evaluaciones realizadas en su empresa.

üìä INFORME T√âCNICO:
‚Ä¢ Empresa: ${company}
‚Ä¢ Servicios realizados seg√∫n orden ${order}
‚Ä¢ Fecha de evaluaci√≥n completada

üìã DOCUMENTOS ENTREGADOS:
‚Ä¢ Informe t√©cnico completo
‚Ä¢ Certificados oficiales
‚Ä¢ Recomendaciones t√©cnicas
‚Ä¢ Anexos fotogr√°ficos

‚úÖ CUMPLIMIENTO:
Los servicios se realizaron conforme a las normas oficiales mexicanas aplicables.

üìû ACLARACIONES:
Para cualquier duda sobre los resultados:
Tel: 222-941-7295
Email: eduwin.ejecutiva@gmail.com

Agradecemos su confianza.

Saludos cordiales,
EJECUTIVA AMBIENTAL`;
        break;

      case 'receipt':
        text = `ASUNTO: RECEPCI√ìN DE PAGO

RECIBO DE PAGO

Lugar y fecha: Puebla, Pue., a ${currentDate}

A QUIEN CORRESPONDA:

Por medio del presente documento, se deja constancia de que SOLUCI√ìN EN INGENIER√çA EJECUTIVA AMBIENTAL S.A. DE C.V., con domicilio en CHIPILO 714, COLONIA LA PAZ, PUEBLA, Pue., ha recibido a entera satisfacci√≥n el pago por parte de:

Nombre o Raz√≥n Social del Cliente: ${company}
Cotizaci√≥n del servicio: ABIERTO
Factura relacionada: NO APLICA. 
Monto recibido: ABIERTO
Cantidad en n√∫mero y letra: ABIERTO 
Forma de pago: Efectivo 
Fecha del pago: ${currentDate}

Este recibo no sustituye el Comprobante Fiscal Digital por Internet (CFDI).`;
        break;

      case 'status_letter':
        text = `A QUIEN CORRESPONDA,

Por medio de la presente hago de su conocimiento que la empresa con raz√≥n social ${company}, para lo que a sus procesos de inspecci√≥n, auditor√≠a o revisiones convengan al cliente, ubicada en ${address}, ha contratado a nuestra Unidad de Inspecci√≥n para llevar a cabo la Evaluaci√≥n de la conformidad aplicando los lineamientos establecidos en la Norma Oficial Mexicana NOM-XXX-STPS-XXXX

El d√≠a ${currentDate} se llevaron a cabo las siguientes actividades:

OPCI√ìN 1:
a) Inspecci√≥n de condiciones f√≠sicas de seguridad
b) Revisi√≥n de cada uno de los Documentos requeridos por la normativa
c) Levantamiento mec√°nico del equipo para elaborar complementos para el expediente t√©cnico
d) Revisi√≥n de Certificados de Fabricaci√≥n
e) Entrevistas

Toda la informaci√≥n recabada en campo se utilizar√° para elaborar los documentos establecidos en la normativa y una vez cumplidos todos los requisitos de la normativa se proceder√° a emitir el dictamen correspondiente.

Hago de su conocimiento que SOLUCI√ìN EN INGENIER√çA EJECUTIVA AMBIENTAL, S.A. de C.V., a trav√©s de nuestra unidad TESTEN SERVICIOS INDUSTRIALES S.A. DE C.V. se encuentra acreditado en Materia de Seguridad e Higiene, espec√≠ficamente en la NOM-020-STPS-2011, por la Entidad Mexicana de acreditaci√≥n (EMA) y aprobado por la secretar√≠a del Trabajo y Previsi√≥n Social (STPS) como Unidad de Inspecci√≥n (Verificaci√≥n) tipo "C" No. UVSTPS180

-----

OPCI√ìN 2:
a) Reconocimiento
b) Evaluaci√≥n
c) Recabado de datos en general

Toda la informaci√≥n recabada en campo se utilizar√° para elaborar los documentos establecidos en la normativa y una vez cumplidos todos los requisitos de la normativa se proceder√° a emitir el informe correspondiente.`;
        break;

      case 'memo':
        text = `EJECUTIVA AMBIENTAL
SEGURIDAD E HIGIENE, CAPACITACI√ìN, MANTENIMIENTO INDUSTRIAL

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                MEMOR√ÅNDUM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

MEMO No: EA-${new Date().getFullYear()}-${String(Date.now()).slice(-3)}
FECHA: ${currentDate}

PARA:    TODO EL PERSONAL
DE:      DIRECCI√ìN GENERAL
ASUNTO:  [ESPECIFICAR ASUNTO]

Por medio del presente, se comunica lo siguiente:

ANTECEDENTES:
_________________________________
_________________________________

DISPOSICIONES:
1. _________________________________
2. _________________________________
3. _________________________________

RESPONSABLES:
‚Ä¢ _________________________________
‚Ä¢ _________________________________

FECHA L√çMITE: _______________

OBSERVACIONES:
_________________________________
_________________________________

Este memor√°ndum entra en vigor a partir de su publicaci√≥n y deber√° ser cumplido por todo el personal.

ATENTAMENTE

___________________________
ING. EDUWIN IV√ÅN HERN√ÅNDEZ Z√ÅRATE
DIRECTOR GENERAL`;
        break;

      case 'invoice':
        text = `No. de Documento: EA-${new Date().getFullYear()}-${String(Date.now()).slice(-4)}
Fecha: ${currentDate}

CLIENTE: ${company}
RFC: ${profileData.rfc || '[RFC CLIENTE]'}
Direcci√≥n: ${address}
Contacto: ${contact}
Tel√©fono: ${phone}

Derivado de su solicitud, le compartimos nuestros datos bancarios:

üè∑Ô∏è Raz√≥n Social: SOLUCI√ìN EN INGENIER√çA EJECUTIVA AMBIENTAL S.A. DE C.V.
Banco: BBVA
üìë RFC: SIE240503N89
üîó CLABE: 012650001233239784

üîó Consulte el PDF aqu√≠: https://n9.cl/ejecutivabancarios

Agradeceremos incluir el n√∫mero de cotizaci√≥n o de factura en el motivo de su transferencia.

Quedamos a sus √≥rdenes para cualquier duda o aclaraci√≥n.`;
        break;
    }

    const output = document.getElementById('textOutput');
    if (output) {
      output.textContent = text;
    }
  }

  function copyTextToClipboard() {
    const output = document.getElementById('textOutput');
    if (output && output.textContent) {
      copyToClipboard(output.textContent);
      showStatus('textStatus', 'Texto copiado al portapapeles', 'success');
    } else {
      showStatus('textStatus', 'No hay texto para copiar', 'warning');
    }
  }

  // Funciones de documentos PDF
  function generateDocumentData() {
    // Auto-completar datos comunes para documentos
    const companyInput = document.getElementById('stps_companyName');
    const addressInput = document.getElementById('stps_address');
    const phoneInput = document.getElementById('stps_phone');
    const emailInput = document.getElementById('stps_email');
    
    if (companyInput) companyInput.value = profileData.companyName || '';
    if (addressInput) addressInput.value = profileData.evaluationAddress || '';
    if (phoneInput) phoneInput.value = profileData.requestorPhone || '';
    if (emailInput) emailInput.value = profileData.reportEmail || '';
    
    showStatus('documentsStatus', 'Datos auto-completados desde el perfil', 'success');
  }

  // Funciones STPS (mantener las existentes)
  function composeAuthorizedList() {
    const checks = [...document.querySelectorAll('.authCheck')]
      .filter(c => c.checked)
      .map(c => c.value);
    
    const other = document.getElementById('stps_otherName')?.value.trim();
    if (other) checks.push(other);
    
    const list = checks.join(', ');
    const ta = document.getElementById('stps_authorizedPersons');
    if (ta && !ta.value.trim()) {
      ta.value = list;
    }
  }

  function generateSTPS() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('es-MX', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });
    
    // Completar datos desde perfil
    const fields = [
      { from: 'companyName', to: 'stps_companyName' },
      { from: 'evaluationAddress', to: 'stps_address' },
      { from: 'requestorPhone', to: 'stps_phone' },
      { from: 'reportEmail', to: 'stps_email' }
    ];
    
    fields.forEach(field => {
      const el = document.getElementById(field.to);
      if (el) {
        el.value = profileData[field.from] || '';
      }
    });
    
    composeAuthorizedList();
    showStatus('documentsStatus', 'Carta Poder STPS auto-completada', 'success');
  }

  async function downloadSTPS() {
    try {
      const { jsPDF } = window.jspdf;
      
      const currentDate = new Date();
      const dateString = currentDate.toLocaleDateString('es-MX', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });
      const year = currentDate.getFullYear();
      
      const authorizedPersons = document.getElementById('stps_authorizedPersons')?.value || '[PERSONA(S) AUTORIZADA(S)]';
      const witness1 = document.getElementById('stps_witness1')?.value || '[TESTIGO 1]';
      const witness2 = document.getElementById('stps_witness2')?.value || '[TESTIGO 2]';
      
      const companyName = profileData.companyName || '[RAZ√ìN SOCIAL]';
      const address = profileData.evaluationAddress || '[DIRECCI√ìN]';
      const phone = profileData.requestorPhone || '[TEL√âFONO]';
      const email = profileData.reportEmail || '[CORREO]';
      const legalRep = profileData.legalRep || '[REPRESENTANTE LEGAL]';
      
      const pdf = new jsPDF('p', 'mm', 'a4');
      
      // Configurar fuente y m√°rgenes
      const margin = 20;
      let yPosition = margin;
      const lineHeight = 5;
      const pageWidth = pdf.internal.pageSize.width;
      const maxWidth = pageWidth - (margin * 2);
      
      function addCenteredText(text, fontSize = 11, isBold = false) {
        if (isBold) pdf.setFont('helvetica', 'bold');
        else pdf.setFont('helvetica', 'normal');
        pdf.setFontSize(fontSize);
        
        const textWidth = pdf.getTextWidth(text);
        const xPosition = (pageWidth - textWidth) / 2;
        pdf.text(text, xPosition, yPosition);
        yPosition += lineHeight;
      }
      
      function addText(text, fontSize = 10, isBold = false, indent = 0) {
        if (isBold) pdf.setFont('helvetica', 'bold');
        else pdf.setFont('helvetica', 'normal');
        pdf.setFontSize(fontSize);
        
        const splitText = pdf.splitTextToSize(text, maxWidth - indent);
        pdf.text(splitText, margin + indent, yPosition);
        yPosition += (splitText.length * lineHeight);
      }
      
      function addSpace(lines = 1) {
        yPosition += (lines * lineHeight);
      }
      
      // Contenido del PDF
      addCenteredText('SECRETAR√çA DEL TRABAJO Y PREVISI√ìN SOCIAL', 9, true);
      addCenteredText('OFICINA DE REPRESENTACI√ìN FEDERAL DEL TRABAJO EN EL ESTADO DE PUEBLA', 8, true);
      addCenteredText('EDIFICIO SELAFE, AV. 31 PONIENTE NO. 2904, P.B., COL. EL VERGEL, C.P. 72400, PUEBLA, PUEBLA', 7, true);
      
      addSpace(2);
      
      // Fecha
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(9);
      const dateText = `Puebla, Puebla, a ${dateString}`;
      const dateWidth = pdf.getTextWidth(dateText);
      pdf.text(dateText, pageWidth - margin - dateWidth, yPosition);
      yPosition += lineHeight * 2;
      
      addText('Por este conducto y con fundamento en el Art√≠culo 19 de la Ley Federal de Procedimiento Administrativo, autorizo mediante el presente escrito a:', 9);
      addSpace(0.5);
      
      addText(authorizedPersons, 9, true);
      addSpace(0.5);
      
      addText('Para que conjunta o indistintamente puedan:', 9);
      
      addText('‚Ä¢ O√≠r y recibir notificaciones', 9, false, 5);
      addText('‚Ä¢ Realizar tr√°mites, gestiones y comparecencias necesarias', 9, false, 5);
      const procedureText = '‚Ä¢ Promover ante la Secretar√≠a del Trabajo y Previsi√≥n Social los procedimientos administrativos correspondientes, incluyendo ingreso o recepci√≥n de oficios de registro, inspecci√≥n, autorizaciones, continuidad de vigencias, aclaraciones, emplazamientos, recursos y cualquier asunto relativo a los recipientes sujetos a presi√≥n instalados en nuestra empresa';
      const splitProcedure = pdf.splitTextToSize(procedureText, maxWidth - 5);
      pdf.text(splitProcedure, margin + 5, yPosition);
      yPosition += (splitProcedure.length * lineHeight);
      
      addSpace(0.5);
      
      addText('DATOS DEL CENTRO DE TRABAJO:', 9, true);
      
      addText(`Nombre/Raz√≥n Social: ${companyName}`, 9, false, 5);
      const addressLines = pdf.splitTextToSize(`Domicilio: ${address}`, maxWidth - 5);
      pdf.text(addressLines, margin + 5, yPosition);
      yPosition += (addressLines.length * lineHeight);
      addText(`Tel√©fono: ${phone}`, 9, false, 5);
      addText(`Correo electr√≥nico: ${email}`, 9, false, 5);
      
      addSpace(0.5);
      
      addText('DOCUMENTOS QUE SE ANEXAN:', 9, true);
      addText('‚Ä¢ Copia simple de identificaci√≥n oficial del Representante Legal', 9, false, 5);
      addText('‚Ä¢ Copia simple de identificaci√≥n oficial de la(s) persona(s) autorizada(s)', 9, false, 5);
      addText('‚Ä¢ Copia simple de identificaci√≥n oficial de los testigos', 9, false, 5);
      
      addSpace(0.5);
      
      addText('Este documento se expide √∫nicamente para los fines se√±alados y dirigido exclusivamente a la dependencia mencionada.', 9);
      addSpace(0.5);
      
      addText(`VIGENCIA: Del ${dateString} al 31 de diciembre de ${year}`, 9, true);
      addSpace(0.5);
      
      addText('Agradeciendo la atenci√≥n prestada, quedo de ustedes.', 9);
      addSpace(2);
      
      addCenteredText('ATENTAMENTE', 9, true);
      addSpace(3);
      
      // L√≠nea para firma
      const signatureLineWidth = 100;
      const signatureX = (pageWidth - signatureLineWidth) / 2;
      pdf.line(signatureX, yPosition, signatureX + signatureLineWidth, yPosition);
      yPosition += lineHeight;
      
      addCenteredText(legalRep, 9, true);
      addCenteredText('Representante Legal del Centro de Trabajo', 8);
      
      addSpace(2);
      
      // Testigos
      addCenteredText('TESTIGOS:', 9, true);
      addSpace(1);
      
      const witnessY = yPosition;
      const leftWitnessX = margin + 25;
      const rightWitnessX = pageWidth - margin - 75;
      
      pdf.line(leftWitnessX, witnessY, leftWitnessX + 50, witnessY);
      pdf.line(rightWitnessX, witnessY, rightWitnessX + 50, witnessY);
      
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(8);
      
      const witness1Text = witness1.length > 25 ? witness1.substring(0, 22) + '...' : witness1;
      const witness2Text = witness2.length > 25 ? witness2.substring(0, 22) + '...' : witness2;
      
      const witness1Width = pdf.getTextWidth(witness1Text);
      const witness2Width = pdf.getTextWidth(witness2Text);
      
      pdf.text(witness1Text, leftWitnessX + (50 - witness1Width) / 2, witnessY + 5);
      pdf.text(witness2Text, rightWitnessX + (50 - witness2Width) / 2, witnessY + 5);
      
      const safeCompanyName = companyName.replace(/[^a-zA-Z0-9]/g, '_');
      const fileName = `Carta_Poder_STPS_${safeCompanyName}_${currentDate.toISOString().split('T')[0]}.pdf`;
      
      pdf.save(fileName);
      showStatus('documentsStatus', 'PDF descargado correctamente', 'success');
    } catch (error) {
      console.error('Error al generar PDF:', error);
      showStatus('documentsStatus', 'Error al generar PDF', 'error');
    }
  }

  // Funciones de otros documentos (placeholder para futuro desarrollo)
  function generateServiceLetter() {
    showStatus('documentsStatus', 'Funci√≥n en desarrollo', 'warning');
  }

  function downloadServiceLetter() {
    showStatus('documentsStatus', 'Funci√≥n en desarrollo', 'warning');
  }

  function generateComplianceLetter() {
    showStatus('documentsStatus', 'Funci√≥n en desarrollo', 'warning');
  }

  function downloadComplianceLetter() {
    showStatus('documentsStatus', 'Funci√≥n en desarrollo', 'warning');
  }

  function generateMeetingAct() {
    showStatus('documentsStatus', 'Funci√≥n en desarrollo', 'warning');
  }

  function downloadMeetingAct() {
    showStatus('documentsStatus', 'Funci√≥n en desarrollo', 'warning');
  }

// ==================== CONFIGURACI√ìN ====================
// ‚ö†Ô∏è IMPORTANTE: Reemplaza esta URL despu√©s de desplegar el Web App
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyxH_KvTpiq1gmHOy4msfyNbC0OPJ2m4-grPQ5zdpRMRE3kSIbaZs30tHYfdhE83EwnbQ/exec';
// Ejemplo: 'https://script.google.com/macros/s/AKfycbx.../exec'

// ==================== FUNCIONES NUEVAS ====================

/**
 * Genera el PDF y lo convierte a base64
 */
async function generatePDFAsBase64() {
  return new Promise((resolve, reject) => {
    try {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      
      // Configuraci√≥n de p√°gina
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 15;
      const maxWidth = pageWidth - (margin * 2);
      let yPosition = margin;
      const lineHeight = 5;
      
      // ========== ENCABEZADO ==========
      // Logo EA
      pdf.setFillColor(30, 90, 62);
      pdf.circle(margin + 5, yPosition + 3, 4, 'F');
      pdf.setTextColor(255, 255, 255);
      pdf.setFontSize(8);
      pdf.setFont('helvetica', 'bold');
      pdf.text('EA', margin + 3, yPosition + 5);
      pdf.setTextColor(0, 0, 0);
      
      // Nombre de la empresa
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(14);
      pdf.text('EJECUTIVA AMBIENTAL', margin + 15, yPosition + 5);
      
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(8);
      const subtitle = 'SEGURIDAD E HIGIENE, CAPACITACI√ìN, MANTENIMIENTO INDUSTRIAL, PROTECCI√ìN CIVIL, MEDIO AMBIENTE';
      pdf.text(subtitle, margin + 15, yPosition + 10);
      
      // T√≠tulo del documento
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(16);
      const titleWidth = pdf.getTextWidth('ORDEN DE TRABAJO');
      pdf.text('ORDEN DE TRABAJO', pageWidth - margin - titleWidth, yPosition + 8);
      
      yPosition += 18;
      pdf.line(margin, yPosition, pageWidth - margin, yPosition);
      yPosition += 3;
      
      // ========== DATOS GENERALES ==========
      const orderNumber = document.getElementById('wo_orderNumber')?.value || '';
      const issueDate = document.getElementById('wo_issueDate')?.value || '';
      const quoteRef = document.getElementById('wo_quoteRef')?.value || '';
      
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(10);
      pdf.text('N¬∞ de Orden:', margin, yPosition);
      pdf.setFont('helvetica', 'normal');
      pdf.text(orderNumber, margin + 30, yPosition);
      
      pdf.setFont('helvetica', 'bold');
      pdf.text('Fecha:', pageWidth - margin - 60, yPosition);
      pdf.setFont('helvetica', 'normal');
      pdf.text(issueDate, pageWidth - margin - 35, yPosition);
      yPosition += lineHeight;
      
      pdf.setFont('helvetica', 'bold');
      pdf.text('Ref. Cotizaci√≥n:', margin, yPosition);
      pdf.setFont('helvetica', 'normal');
      pdf.text(quoteRef, margin + 35, yPosition);
      yPosition += lineHeight + 2;
      
      // ========== INFORMACI√ìN DEL CLIENTE ==========
      pdf.setFillColor(30, 90, 62);
      pdf.rect(margin, yPosition, maxWidth, 6, 'F');
      pdf.setTextColor(255, 255, 255);
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(10);
      pdf.text('INFORMACI√ìN DEL CLIENTE', margin + 2, yPosition + 4);
      pdf.setTextColor(0, 0, 0);
      yPosition += 8;
      
      const clientName = document.getElementById('wo_clientName')?.value || '';
      const branch = document.getElementById('wo_branch')?.value || '';
      const serviceAddress = document.getElementById('wo_serviceAddress')?.value || '';
      const contactName = document.getElementById('wo_contactName')?.value || '';
      const phone = document.getElementById('wo_phone')?.value || '';
      const email = document.getElementById('wo_email')?.value || '';
      
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(9);
      pdf.text('Raz√≥n Social:', margin, yPosition);
      pdf.setFont('helvetica', 'normal');
      pdf.text(clientName, margin + 30, yPosition);
      yPosition += lineHeight;
      
      pdf.setFont('helvetica', 'bold');
      pdf.text('Sucursal:', margin, yPosition);
      pdf.setFont('helvetica', 'normal');
      pdf.text(branch, margin + 30, yPosition);
      yPosition += lineHeight;
      
      pdf.setFont('helvetica', 'bold');
      pdf.text('Direcci√≥n:', margin, yPosition);
      pdf.setFont('helvetica', 'normal');
      const addressLines = pdf.splitTextToSize(serviceAddress, maxWidth - 30);
      pdf.text(addressLines, margin + 30, yPosition);
      yPosition += (addressLines.length * lineHeight);
      
      pdf.setFont('helvetica', 'bold');
      pdf.text('Contacto:', margin, yPosition);
      pdf.setFont('helvetica', 'normal');
      pdf.text(contactName, margin + 30, yPosition);
      
      pdf.setFont('helvetica', 'bold');
      pdf.text('Tel:', margin + 100, yPosition);
      pdf.setFont('helvetica', 'normal');
      pdf.text(phone, margin + 110, yPosition);
      yPosition += lineHeight + 2;
      
      // ========== DESARROLLO DEL TRABAJO ==========
      pdf.setFillColor(30, 90, 62);
      pdf.rect(margin, yPosition, maxWidth, 6, 'F');
      pdf.setTextColor(255, 255, 255);
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(10);
      pdf.text('DESARROLLO DEL TRABAJO', margin + 2, yPosition + 4);
      pdf.setTextColor(0, 0, 0);
      yPosition += 10;
      
      // Tabla de trabajos
      const colWidths = [40, 40, 30, 30, maxWidth - 140];
      const headers = ['SERVICIO', 'PERSONAL', 'FECHA', 'CANTIDAD', 'OBSERVACIONES'];
      
      // Headers de la tabla
      pdf.setFillColor(240, 240, 240);
      pdf.rect(margin, yPosition, maxWidth, 7, 'F');
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(8);
      
      let xPos = margin + 2;
      headers.forEach((header, i) => {
        pdf.text(header, xPos, yPosition + 5);
        xPos += colWidths[i];
      });
      yPosition += 7;
      
      // Filas de la tabla
      const workRows = document.querySelectorAll('#workTableBody tr');
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(8);
      
      workRows.forEach(row => {
        const inputs = row.querySelectorAll('input, select, textarea');
        if (inputs.length >= 5 && inputs[0].value) {
          const rowData = [
            inputs[0].value, // Servicio
            inputs[1].value, // Personal
            inputs[2].value, // Fecha
            inputs[3].value, // Cantidad
            inputs[4].value  // Observaciones
          ];
          
          let maxHeight = 7;
          xPos = margin + 2;
          
          rowData.forEach((data, i) => {
            const lines = pdf.splitTextToSize(data, colWidths[i] - 4);
            const cellHeight = lines.length * 4;
            if (cellHeight > maxHeight) maxHeight = cellHeight;
          });
          
          pdf.rect(margin, yPosition, maxWidth, maxHeight);
          xPos = margin + 2;
          
          rowData.forEach((data, i) => {
            const lines = pdf.splitTextToSize(data, colWidths[i] - 4);
            pdf.text(lines, xPos, yPosition + 4);
            xPos += colWidths[i];
          });
          
          yPosition += maxHeight;
        }
      });
      
      yPosition += 5;
      
      // Observaciones generales
      const generalObs = document.getElementById('wo_generalObservations')?.value || '';
      if (generalObs) {
        pdf.setFont('helvetica', 'bold');
        pdf.setFontSize(9);
        pdf.text('Observaciones Generales:', margin, yPosition);
        yPosition += lineHeight;
        
        pdf.setFont('helvetica', 'normal');
        pdf.setFontSize(8);
        const obsLines = pdf.splitTextToSize(generalObs, maxWidth);
        pdf.text(obsLines, margin, yPosition);
        yPosition += (obsLines.length * lineHeight) + 3;
      }
      
      // ========== FIRMAS ==========
      pdf.setFillColor(30, 90, 62);
      pdf.rect(margin, yPosition, maxWidth, 6, 'F');
      pdf.setTextColor(255, 255, 255);
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(10);
      pdf.text('AUTORIZACI√ìN Y FIRMAS', margin + 2, yPosition + 4);
      pdf.setTextColor(0, 0, 0);
      yPosition += 10;
      
      const preparedBy = document.getElementById('wo_preparedBy')?.value || '';
      const authorizedBy = document.getElementById('wo_authorizedBy')?.value || '';
      
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(8);
      pdf.text('Realiz√≥:', margin, yPosition);
      pdf.setFont('helvetica', 'normal');
      pdf.text(preparedBy, margin + 20, yPosition);
      
      pdf.setFont('helvetica', 'bold');
      pdf.text('Autoriz√≥:', margin + 100, yPosition);
      pdf.setFont('helvetica', 'normal');
      pdf.text(authorizedBy, margin + 120, yPosition);
      yPosition += 15;
      
      // L√≠neas para firmas
      pdf.line(margin, yPosition, margin + 60, yPosition);
      pdf.line(margin + 100, yPosition, margin + 160, yPosition);
      yPosition += 3;
      
      pdf.setFontSize(7);
      pdf.text('Firma del Cliente', margin, yPosition);
      pdf.text('Firma Ejecutiva Ambiental', margin + 100, yPosition);
      
      // Generar base64
      const pdfBase64 = pdf.output('dataurlstring');
      resolve(pdfBase64);
      
    } catch (error) {
      console.error('Error generando PDF:', error);
      reject(error);
    }
  });
}

/**
 * Recopila todos los datos del formulario para enviar al Apps Script
 */
function recopilarDatosOT() {
  const datos = {
    ordenTrabajo: document.getElementById('wo_orderNumber')?.value || '',
    referenciaCotizacion: document.getElementById('wo_quoteRef')?.value || '',
    clienteInicial: profileData.companyName || '',
    clienteFinal: document.getElementById('wo_clientName')?.value || '',
    nom: '',
    proveedor: '',
    personal: '',
    fechaVisita: '',
    sucursal: document.getElementById('wo_branch')?.value || '',
    direccion: document.getElementById('wo_serviceAddress')?.value || '',
    contacto: document.getElementById('wo_contactName')?.value || '',
    correo: document.getElementById('wo_email')?.value || '',
    telefono: document.getElementById('wo_phone')?.value || ''
  };
  
  // Extraer NOMs y personal de la tabla de trabajo
  const workRows = document.querySelectorAll('#workTableBody tr');
  const noms = [];
  const personales = [];
  const fechas = [];
  
  workRows.forEach(row => {
    const inputs = row.querySelectorAll('input, select, textarea');
    if (inputs.length >= 5) {
      const servicio = inputs[0].value.trim(); // Primera columna: SERVICIO (NOM)
      const personal = inputs[1].value.trim(); // Segunda columna: PERSONAL
      const fecha = inputs[2].value.trim();    // Tercera columna: FECHA
      
      if (servicio) noms.push(servicio);
      if (personal) personales.push(personal);
      if (fecha) fechas.push(fecha);
    }
  });
  
  datos.nom = noms.join(', ');
  datos.personal = personales.join(', ');
  datos.fechaVisita = fechas.length > 0 ? fechas[0] : '';
  
  return datos;
}
/**
 * Env√≠a el PDF y los datos al Apps Script
 */
async function enviarAAppsScript(pdfBase64, datos) {
  try {
    console.log('üì§ Enviando datos a Apps Script...');
    
    // Validar que tenemos la URL configurada
    if (!WEB_APP_URL || WEB_APP_URL === 'TU_URL_DEL_WEB_APP_AQUI') {
      throw new Error('‚ö†Ô∏è Web App URL no configurada. Por favor configura WEB_APP_URL en el c√≥digo.');
    }
    
    // Preparar payload
    const payload = {
      pdfBase64: pdfBase64,
      ...datos
    };
    
    // Enviar POST al Web App
    const response = await fetch(WEB_APP_URL, {
      method: 'POST',
      mode: 'no-cors', // Importante para Apps Script
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    
    // NOTA: Con mode: 'no-cors', no podemos leer la respuesta directamente
    // pero el Apps Script s√≠ procesar√° los datos correctamente
    
    console.log('‚úÖ Datos enviados correctamente');
    return { success: true };
    
  } catch (error) {
    console.error('‚ùå Error enviando a Apps Script:', error);
    throw error;
  }
}

/**
 * FUNCI√ìN PRINCIPAL: Enviar y Registrar OT
 * Esta funci√≥n reemplaza a sendWorkOrder()
 */
async function sendAndRegisterWorkOrder() {
  try {
    // Validar email
    const email = document.getElementById('wo_email')?.value;
    const orderNumber = document.getElementById('wo_orderNumber')?.value || 'Nueva';
    
    if (!email) {
      showStatus('workorderStatus', 'No hay email de cliente disponible', 'warning');
      return;
    }
    
    // Mostrar mensaje de procesamiento
    showStatus('workorderStatus', '‚è≥ Generando y registrando OT...', 'warning');
    
    // 1. Generar PDF como base64
    console.log('1Ô∏è‚É£ Generando PDF...');
    const pdfBase64 = await generatePDFAsBase64();
    
    // 2. Recopilar datos del formulario
    console.log('2Ô∏è‚É£ Recopilando datos...');
    const datos = recopilarDatosOT();
    
    // 3. Enviar a Apps Script
    console.log('3Ô∏è‚É£ Enviando a Apps Script...');
    await enviarAAppsScript(pdfBase64, datos);
    
    // 4. Descargar PDF localmente (para que el usuario lo tenga)
    console.log('4Ô∏è‚É£ Descargando PDF local...');
    const pdfBlob = await fetch(pdfBase64).then(r => r.blob());
    const url = window.URL.createObjectURL(pdfBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `OT_${orderNumber}_${datos.clienteFinal.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    // 5. Abrir cliente de correo (como antes)
    console.log('5Ô∏è‚É£ Preparando email...');
    const cc = 'eduwin.ejecutiva@gmail.com';
    const branch = profileData.branch || 'No especificada';
    const installed = profileData.installedCapacity || 'No especificada';
    const operation = profileData.operationCapacity || 'No especificada';
    const patronal = profileData.patronalRegistry || 'No especificado';
    const giro = profileData.businessType || 'No especificado';
    const company = profileData.companyName || 'Cliente';
    const address = profileData.evaluationAddress || '';
    const maps = address ? `https://maps.google.com/maps?q=${encodeURIComponent(address.trim())}` : 'Direcci√≥n no disponible';
    
    const subject = `Orden de Trabajo ${orderNumber} - ${company} - Ejecutiva Ambiental`;
    const body = `Estimado,

Adjunto encontrar√° la Orden de Trabajo ${orderNumber} para los servicios programados.

üè¢ Raz√≥n Social: ${company}
‚Ä¢ Sucursal: ${branch}
‚Ä¢ Giro/Actividad: ${giro}
‚Ä¢ Registro Patronal: ${patronal}

‚öôÔ∏è Capacidad Instalada: ${installed}
‚öô Capacidad de Operaci√≥n: ${operation}

üìç Direcci√≥n: ${address}
üîó Google Maps: ${maps}

Saludos cordiales,
Ejecutiva Ambiental
Tel: 222-941-7295`;

    window.location.href = `mailto:${email}?cc=${cc}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    
    // 6. Mostrar mensaje de √©xito
    showStatus('workorderStatus', `‚úÖ OT ${orderNumber} registrada y guardada en Drive. Email preparado.`, 'success');
    
    console.log('‚úÖ Proceso completado exitosamente');
    
  } catch (error) {
    console.error('‚ùå Error en sendAndRegisterWorkOrder:', error);
    showStatus('workorderStatus', `‚ùå Error: ${error.message}`, 'error');
  }
}

/**
 * Funci√≥n original sendWorkOrder (mantener como backup)
 * Renombrada a sendWorkOrderSimple para no interferir
 */
function sendWorkOrderSimple() {
  const email = document.getElementById('wo_email')?.value;
  const orderNumber = document.getElementById('wo_orderNumber')?.value || 'Nueva';
  
  if (!email) {
    showStatus('workorderStatus', 'No hay email de cliente disponible', 'warning');
    return;
  }
  
  const cc = 'eduwin.ejecutiva@gmail.com';
  const branch = profileData.branch || 'No especificada';
  const installed = profileData.installedCapacity || 'No especificada';
  const operation = profileData.operationCapacity || 'No especificada';
  const patronal = profileData.patronalRegistry || 'No especificado';
  const giro = profileData.businessType || 'No especificado';
  const company = profileData.companyName || 'Cliente';
  const address = profileData.evaluationAddress || '';
  const maps = address ? `https://maps.google.com/maps?q=${encodeURIComponent(address.trim())}` : 'Direcci√≥n no disponible';
  
  const subject = `Orden de Trabajo ${orderNumber} - ${company} - Ejecutiva Ambiental`;
  const body = `Estimado,

Adjunto encontrar√° la Orden de Trabajo ${orderNumber} para los servicios programados.

üè¢ Raz√≥n Social: ${company}
‚Ä¢ Sucursal: ${branch}
‚Ä¢ Giro/Actividad: ${giro}
‚Ä¢ Registro Patronal: ${patronal}

‚öôÔ∏è Capacidad Instalada: ${installed}
‚öô Capacidad de Operaci√≥n: ${operation}

üìç Direcci√≥n: ${address}
üîó Google Maps: ${maps}

Saludos cordiales,
Ejecutiva Ambiental
Tel: 222-941-7295`;

  window.location.href = `mailto:${email}?cc=${cc}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  showStatus('workorderStatus', `Email preparado con copia a ${cc}`, 'success');
}

// ==================== EXPONER FUNCIONES GLOBALMENTE ====================
// Agregar al final del archivo, junto con las otras funciones window.*

window.sendAndRegisterWorkOrder = sendAndRegisterWorkOrder;
window.sendWorkOrderSimple = sendWorkOrderSimple;

  
  
  // Event listeners y inicializaci√≥n
  document.addEventListener('DOMContentLoaded', () => {
    // Configurar file input
    const fileInput = document.getElementById('profileFile');
    const fileNameSpan = document.getElementById('fileSelectedName');
    
    if (fileInput && fileNameSpan) {
      fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          fileNameSpan.textContent = `Archivo: ${this.files[0].name}`;
          fileNameSpan.style.color = '#28a745';
          fileNameSpan.style.fontWeight = 'bold';
        } else {
          fileNameSpan.textContent = 'No se ha seleccionado ning√∫n archivo.';
          fileNameSpan.style.color = '#666';
          fileNameSpan.style.fontWeight = 'normal';
        }
      });
    }
    
    // Establecer fecha actual en orden de trabajo
    const issueDateInput = document.getElementById('wo_issueDate');
    if (issueDateInput) {
      issueDateInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Listeners para STPS
    document.querySelectorAll('.authCheck').forEach(checkbox => {
      checkbox.addEventListener('change', composeAuthorizedList);
    });
    
    const stpsOtherInput = document.getElementById('stps_otherName');
    if (stpsOtherInput) {
      stpsOtherInput.addEventListener('input', composeAuthorizedList);
    }
    
    // Sincronizar datos cuando se cambie de pesta√±a
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', syncData);
    });
    
    console.log('‚úÖ Sistema Ejecutiva Ambiental cargado correctamente');
  });

  // Exponer funciones globalmente para onclick handlers
  window.switchTab = switchTab;
  window.loadProfile = loadProfile;
  window.saveProfile = saveProfile;
  window.downloadProfileTemplate = downloadProfileTemplate;
  window.exportToExcelFormat = exportToExcelFormat;
  window.sendToClient = sendToClient;
  window.generateWorkOrder = generateWorkOrder;
  window.addWorkRow = addWorkRow;
  window.removeRow = removeRow;
  window.saveWorkOrder = saveWorkOrder;
  window.printWorkOrder = printWorkOrder;
  window.sendWorkOrder = sendWorkOrder;
  window.generateTextFromProfile = generateTextFromProfile;
  window.selectTextTemplate = selectTextTemplate;
  window.copyTextToClipboard = copyTextToClipboard;
  window.generateDocumentData = generateDocumentData;
  window.generateSTPS = generateSTPS;
  window.downloadSTPS = downloadSTPS;
  window.generateServiceLetter = generateServiceLetter;
  window.downloadServiceLetter = downloadServiceLetter;
  window.generateComplianceLetter = generateComplianceLetter;
  window.downloadComplianceLetter = downloadComplianceLetter;
  window.generateMeetingAct = generateMeetingAct;
  window.downloadMeetingAct = downloadMeetingAct;
  window.syncData = syncData;
</script>

</body>
</html>
      
